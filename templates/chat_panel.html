<style>
#chat-panel{position:fixed;bottom:0;left:0;right:0;z-index:400;display:none;flex-direction:column;pointer-events:none;transition:none}
#feed-sheet{pointer-events:auto;background:rgba(17,17,17,.96);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border-top-left-radius:16px;border-top-right-radius:16px;display:flex;flex-direction:column;overflow:hidden;will-change:transform,height;box-shadow:0 -2px 20px rgba(0,0,0,.5)}
#feed-handle-bar{padding:10px 0 6px;display:flex;justify-content:center;cursor:grab;touch-action:none;flex-shrink:0}
#feed-handle-bar .handle{width:36px;height:4px;border-radius:2px;background:#555}
#feed-header{display:flex;align-items:center;justify-content:space-between;padding:0 16px 8px;flex-shrink:0}
#feed-header .feed-title{font-family:system-ui,-apple-system,sans-serif;font-size:15px;font-weight:700;color:#fff;letter-spacing:.3px}
#feed-header .feed-badge{background:#4a9eff;color:#fff;font-size:10px;border-radius:50%;min-width:18px;height:18px;display:none;align-items:center;justify-content:center;font-weight:700;padding:0 5px;font-family:system-ui,-apple-system,sans-serif}
#feed-messages{flex:1;overflow-y:auto;padding:4px 16px;display:flex;flex-direction:column;gap:4px;-webkit-overflow-scrolling:touch;min-height:0}
.feed-item{display:flex;gap:8px;align-items:flex-start;padding:5px 0;animation:feedIn .3s ease}
@keyframes feedIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.feed-avatar{width:28px;height:28px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:700;color:#fff;font-family:system-ui,-apple-system,sans-serif}
.feed-avatar.ai{background:rgba(74,158,255,.2);color:#4a9eff}
.feed-avatar.self{background:#4a9eff;color:#fff}
.feed-body{flex:1;min-width:0}
.feed-name{font-size:11px;font-weight:600;color:#4a9eff;margin-bottom:1px;font-family:system-ui,-apple-system,sans-serif}
.feed-name.ai{color:#7bb8ff}
.feed-name.self{color:#fff}
.feed-text{font-size:13px;line-height:1.35;color:#ccc;word-wrap:break-word;font-family:system-ui,-apple-system,sans-serif}
.feed-text.ai{color:#a8cce8;font-style:italic}
.feed-text.self{color:#fff}
.feed-system{font-size:11px;color:#555;text-align:center;padding:3px 0;font-family:system-ui,-apple-system,sans-serif}
.feed-time{font-size:10px;color:#444;margin-top:1px;font-family:system-ui,-apple-system,sans-serif}
#feed-input-bar{display:flex;padding:8px 12px;gap:8px;border-top:1px solid #222;flex-shrink:0}
#feed-input{flex:1;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:20px;padding:9px 14px;color:#fff;font-size:14px;outline:none;font-family:system-ui,-apple-system,sans-serif}
#feed-input:focus{border-color:#4a9eff}
#feed-input::placeholder{color:#555}
#feed-send{background:#4a9eff;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .2s;font-family:system-ui,-apple-system,sans-serif}
#feed-send:active{opacity:.7}
</style>

<div id="chat-panel">
  <div id="feed-sheet">
    <div id="feed-handle-bar"><div class="handle"></div></div>
    <div id="feed-header">
      <div style="display:flex;align-items:center;gap:8px">
        <span class="feed-title">Live Feed</span>
        <span class="feed-badge" id="feed-badge">0</span>
      </div>
    </div>
    <div id="feed-messages"></div>
    <div id="feed-input-bar">
      <input id="feed-input" type="text" placeholder="Say something..." maxlength="500" autocomplete="off">
      <button id="feed-send" onclick="sendChat()">&#9654;</button>
    </div>
  </div>
</div>

<script>
// Sheet snap heights (fraction of viewport)
var SNAP_MIN = 0.18;   // collapsed â€” just header + input
var SNAP_MED = 0.42;   // medium
var SNAP_FULL = 0.85;  // full height
var feedSnap = 'med';   // current snap: 'min', 'med', 'full'
var unreadCount = 0;

var sheetEl, handleEl;
var dragging = false;
var dragStartY = 0;
var dragStartH = 0;

function initFeedSheet() {
  sheetEl = document.getElementById('feed-sheet');
  handleEl = document.getElementById('feed-handle-bar');

  // Touch events
  handleEl.addEventListener('touchstart', onDragStart, { passive: false });
  document.addEventListener('touchmove', onDragMove, { passive: false });
  document.addEventListener('touchend', onDragEnd);

  // Mouse events (desktop)
  handleEl.addEventListener('mousedown', onDragStart);
  document.addEventListener('mousemove', onDragMove);
  document.addEventListener('mouseup', onDragEnd);

  // Set initial snap
  snapTo('med', false);
}

function getSnapPx(snap) {
  var vh = window.innerHeight;
  if (snap === 'min') return Math.round(vh * SNAP_MIN);
  if (snap === 'full') return Math.round(vh * SNAP_FULL);
  return Math.round(vh * SNAP_MED);
}

function snapTo(snap, animate) {
  feedSnap = snap;
  var h = getSnapPx(snap);
  if (animate !== false) {
    sheetEl.style.transition = 'height .3s cubic-bezier(.2,.9,.3,1)';
    setTimeout(function() { sheetEl.style.transition = 'none'; }, 320);
  }
  sheetEl.style.height = h + 'px';
  if (snap !== 'min') scrollFeed();
}

function onDragStart(e) {
  dragging = true;
  dragStartY = e.touches ? e.touches[0].clientY : e.clientY;
  dragStartH = sheetEl.offsetHeight;
  sheetEl.style.transition = 'none';
  if (e.cancelable) e.preventDefault();
}

function onDragMove(e) {
  if (!dragging) return;
  var clientY = e.touches ? e.touches[0].clientY : e.clientY;
  var dy = dragStartY - clientY; // positive = dragging up = bigger
  var newH = Math.max(getSnapPx('min'), Math.min(getSnapPx('full'), dragStartH + dy));
  sheetEl.style.height = newH + 'px';
  if (e.cancelable) e.preventDefault();
}

function onDragEnd(e) {
  if (!dragging) return;
  dragging = false;
  var h = sheetEl.offsetHeight;
  var vh = window.innerHeight;
  var frac = h / vh;

  // Snap to nearest
  var midLow = (SNAP_MIN + SNAP_MED) / 2;
  var midHigh = (SNAP_MED + SNAP_FULL) / 2;

  if (frac < midLow) {
    snapTo('min', true);
  } else if (frac < midHigh) {
    snapTo('med', true);
  } else {
    snapTo('full', true);
  }
}

function updateFeedBadge() {
  var badge = document.getElementById('feed-badge');
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

function scrollFeed() {
  var el = document.getElementById('feed-messages');
  setTimeout(function() { el.scrollTop = el.scrollHeight; }, 50);
}

function escapeHtml(str) {
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function formatFeedTime(ts) {
  if (!ts) return '';
  var d = new Date(ts * 1000);
  var h = d.getHours();
  var m = d.getMinutes();
  return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
}

function appendChatMsg(sender, text, isAi, isSelf, timestamp) {
  var container = document.getElementById('feed-messages');
  var item = document.createElement('div');
  item.className = 'feed-item';

  var avatar = document.createElement('div');
  var initial = (sender && sender[0]) ? sender[0].toUpperCase() : '?';

  if (isAi) {
    avatar.className = 'feed-avatar ai';
    avatar.textContent = 'AI';
  } else if (isSelf) {
    avatar.className = 'feed-avatar self';
    avatar.textContent = initial;
  } else {
    avatar.className = 'feed-avatar';
    avatar.textContent = initial;
  }

  var body = document.createElement('div');
  body.className = 'feed-body';

  var nameEl = document.createElement('div');
  nameEl.className = 'feed-name' + (isAi ? ' ai' : isSelf ? ' self' : '');
  nameEl.textContent = isAi ? 'Bounce AI' : (isSelf ? 'You' : sender);

  var textEl = document.createElement('div');
  textEl.className = 'feed-text' + (isAi ? ' ai' : isSelf ? ' self' : '');
  textEl.textContent = text;

  body.appendChild(nameEl);
  body.appendChild(textEl);

  if (timestamp) {
    var timeEl = document.createElement('div');
    timeEl.className = 'feed-time';
    timeEl.textContent = formatFeedTime(timestamp);
    body.appendChild(timeEl);
  }

  item.appendChild(avatar);
  item.appendChild(body);
  container.appendChild(item);
  scrollFeed();

  // If collapsed, bump unread and auto-expand to med
  if (feedSnap === 'min') {
    unreadCount++;
    updateFeedBadge();
  }
}

function appendSystemMsg(text) {
  var container = document.getElementById('feed-messages');
  var div = document.createElement('div');
  div.className = 'feed-system';
  div.textContent = text;
  container.appendChild(div);
  scrollFeed();
}

function sendChat() {
  var input = document.getElementById('feed-input');
  var text = input.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: 'chat_message', text: text }));
  appendChatMsg(myName, text, false, true, Date.now() / 1000);
  input.value = '';
}

document.addEventListener('keydown', function(e) {
  if (e.target.id === 'feed-input' && e.key === 'Enter') {
    sendChat();
  }
});

// Init sheet on load
initFeedSheet();

// Monkey-patch handleMessage to intercept chat-related messages
var _origHandleMessage = handleMessage;
handleMessage = function(msg) {
  _origHandleMessage(msg);

  if (msg.type === 'chat_message') {
    if (!msg.is_ai && msg.guest_id === myGuestId) return;
    appendChatMsg(msg.sender, msg.text, msg.is_ai, false, msg.timestamp);
  }
  if (msg.type === 'chat_history') {
    (msg.messages || []).forEach(function(m) {
      appendChatMsg(m.sender, m.text, m.is_ai, false, m.timestamp);
    });
  }
  if (msg.type === 'guest_joined' && msg.guest_id !== myGuestId) {
    appendSystemMsg(msg.display_name + ' joined the bounce');
  }
  if (msg.type === 'guest_left' && msg.guest_id !== myGuestId) {
    appendSystemMsg(msg.display_name + ' left');
  }
};
</script>
