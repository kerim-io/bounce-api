<style>
#chat-panel{position:fixed;bottom:0;left:0;right:0;z-index:400;display:none;flex-direction:column;pointer-events:none}
#chat-toggle{pointer-events:auto;align-self:flex-start;margin:0 0 0 12px;background:rgba(26,26,26,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid #333;color:#fff;font-size:13px;font-weight:600;padding:8px 14px;border-radius:18px;cursor:pointer;display:flex;align-items:center;gap:6px}
#chat-toggle .badge{background:#4a9eff;color:#fff;font-size:11px;border-radius:50%;width:18px;height:18px;display:none;align-items:center;justify-content:center;font-weight:700}
#chat-body{pointer-events:auto;background:rgba(17,17,17,.92);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid #333;display:flex;flex-direction:column;max-height:40vh;overflow:hidden}
#chat-messages{flex:1;overflow-y:auto;padding:10px 14px;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.chat-msg{font-size:14px;line-height:1.4;padding:6px 10px;border-radius:12px;max-width:85%;word-wrap:break-word}
.chat-msg.user{background:#222;color:#ddd;align-self:flex-start}
.chat-msg.user .chat-name{color:#4a9eff;font-weight:600;font-size:12px;margin-bottom:2px}
.chat-msg.ai{background:rgba(74,158,255,.12);border:1px solid rgba(74,158,255,.2);color:#c0d8f0;align-self:flex-start;font-style:italic}
.chat-msg.ai .chat-name{color:#4a9eff;font-weight:600;font-size:12px;margin-bottom:2px;font-style:normal}
.chat-msg.self{background:#4a9eff;color:#fff;align-self:flex-end}
.chat-system{font-size:12px;color:#666;text-align:center;padding:4px 0}
#chat-input-bar{display:flex;padding:8px 12px;gap:8px;border-top:1px solid #222;background:rgba(26,26,26,.95)}
#chat-input{flex:1;background:#222;border:1px solid #333;border-radius:20px;padding:8px 14px;color:#fff;font-size:14px;outline:none}
#chat-input:focus{border-color:#4a9eff}
#chat-send{background:#4a9eff;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
</style>

<div id="chat-panel">
  <button id="chat-toggle" onclick="toggleChat()">
    Chat <span class="badge" id="chat-badge">0</span>
  </button>
  <div id="chat-body" style="display:none">
    <div id="chat-messages"></div>
    <div id="chat-input-bar">
      <input id="chat-input" type="text" placeholder="Say something..." maxlength="500" autocomplete="off">
      <button id="chat-send" onclick="sendChat()">&#9654;</button>
    </div>
  </div>
</div>

<script>
var chatExpanded = false;
var unreadCount = 0;

function toggleChat() {
  chatExpanded = !chatExpanded;
  var body = document.getElementById('chat-body');
  body.style.display = chatExpanded ? 'flex' : 'none';
  if (chatExpanded) {
    unreadCount = 0;
    updateChatBadge();
    scrollChat();
    document.getElementById('chat-input').focus();
  }
}

function updateChatBadge() {
  var badge = document.getElementById('chat-badge');
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

function scrollChat() {
  var el = document.getElementById('chat-messages');
  el.scrollTop = el.scrollHeight;
}

function escapeHtml(str) {
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function appendChatMsg(sender, text, isAi, isSelf) {
  var container = document.getElementById('chat-messages');
  var div = document.createElement('div');
  if (isAi) {
    div.className = 'chat-msg ai';
    div.innerHTML = '<div class="chat-name">Bounce AI</div>' + escapeHtml(text);
  } else if (isSelf) {
    div.className = 'chat-msg self';
    div.textContent = text;
  } else {
    div.className = 'chat-msg user';
    div.innerHTML = '<div class="chat-name">' + escapeHtml(sender) + '</div>' + escapeHtml(text);
  }
  container.appendChild(div);
  scrollChat();
  if (!chatExpanded) {
    unreadCount++;
    updateChatBadge();
  }
}

function appendSystemMsg(text) {
  var container = document.getElementById('chat-messages');
  var div = document.createElement('div');
  div.className = 'chat-system';
  div.textContent = text;
  container.appendChild(div);
  scrollChat();
}

function sendChat() {
  var input = document.getElementById('chat-input');
  var text = input.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: 'chat_message', text: text }));
  appendChatMsg(myName, text, false, true);
  input.value = '';
}

document.addEventListener('keydown', function(e) {
  if (e.target.id === 'chat-input' && e.key === 'Enter') {
    sendChat();
  }
});

// Monkey-patch handleMessage to intercept chat-related messages
var _origHandleMessage = handleMessage;
handleMessage = function(msg) {
  _origHandleMessage(msg);

  if (msg.type === 'chat_message') {
    if (!msg.is_ai && msg.guest_id === myGuestId) return;
    appendChatMsg(msg.sender, msg.text, msg.is_ai, false);
  }
  if (msg.type === 'chat_history') {
    (msg.messages || []).forEach(function(m) {
      appendChatMsg(m.sender, m.text, m.is_ai, false);
    });
  }
  if (msg.type === 'guest_joined' && msg.guest_id !== myGuestId) {
    appendSystemMsg(msg.display_name + ' joined');
  }
  if (msg.type === 'guest_left' && msg.guest_id !== myGuestId) {
    appendSystemMsg(msg.display_name + ' left');
  }
};
</script>
