<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>{{VENUE_NAME}} - Bounce</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#fff;height:100vh;overflow:hidden}
#map{width:100%;height:100vh}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000}
.card{background:#1a1a1a;border-radius:16px;padding:32px;max-width:380px;width:90%;text-align:center}
.card h1{font-size:20px;margin-bottom:4px;color:#fff}
.card .venue{font-size:14px;color:#aaa;margin-bottom:6px}
.card .msg{font-size:15px;color:#ccc;margin-bottom:20px;font-style:italic}
.card .by{font-size:13px;color:#888;margin-bottom:20px}
.card input{width:100%;padding:14px;border-radius:10px;border:1px solid #333;background:#222;color:#fff;font-size:16px;outline:none;margin-bottom:16px}
.card input:focus{border-color:#4a9eff}
.card button{width:100%;padding:14px;border-radius:10px;border:none;background:#4a9eff;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.card button:disabled{opacity:.5;cursor:not-allowed}
#info-bar{position:fixed;top:0;left:0;right:0;background:rgba(17,17,17,.9);backdrop-filter:blur(10px);padding:12px 16px;z-index:500;display:none;border-bottom:1px solid #222}
#info-bar .title{font-size:16px;font-weight:600}
#info-bar .sub{font-size:12px;color:#aaa}
#status{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(17,17,17,.9);padding:8px 16px;border-radius:20px;font-size:12px;color:#aaa;z-index:500;display:none}
.map-label{position:absolute;background:rgba(0,0,0,.75);color:#fff;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:600;white-space:nowrap;transform:translate(-50%,6px);pointer-events:none}
</style>
</head>
<body>

<div id="overlay">
  <div class="card">
    <h1>{{VENUE_NAME}}</h1>
    <div class="venue">{{VENUE_ADDRESS}}</div>
    <div class="msg">{{MESSAGE}}</div>
    <div class="by">by {{CREATOR_NAME}}</div>
    <input id="name-input" type="text" placeholder="Enter your name" maxlength="50" autocomplete="off">
    <button id="join-btn" disabled onclick="joinBounce()">Join Map</button>
  </div>
</div>

<div id="info-bar">
  <div class="title">{{VENUE_NAME}}</div>
  <div class="sub" id="people-count"></div>
</div>

<div id="status"></div>

<div id="map"></div>

<script>
const VENUE_LAT = {{LATITUDE}};
const VENUE_LNG = {{LONGITUDE}};
const SHARE_TOKEN = "{{SHARE_TOKEN}}";
const WS_BASE = "{{WS_BASE}}";
const STORAGE_KEY_ID = 'bounce_guest_id_' + SHARE_TOKEN;
const STORAGE_KEY_NAME = 'bounce_guest_name_' + SHARE_TOKEN;

let map, ws, geoWatchId;
let markers = {};       // keyed by "user_{id}" or "guest_{id}"
let labelOverlays = {}; // name labels keyed same as markers
let myGuestId;
let myName;
let reconnectTimer;
let pingInterval;

const nameInput = document.getElementById('name-input');
const joinBtn = document.getElementById('join-btn');

nameInput.addEventListener('input', () => {
  joinBtn.disabled = !nameInput.value.trim();
});

nameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && nameInput.value.trim()) joinBounce();
});

function joinBounce() {
  myName = nameInput.value.trim();
  if (!myName) return;

  // Generate or retrieve guest_id — use localStorage so it survives refresh
  myGuestId = localStorage.getItem(STORAGE_KEY_ID);
  if (!myGuestId) {
    myGuestId = crypto.randomUUID();
    localStorage.setItem(STORAGE_KEY_ID, myGuestId);
  }
  localStorage.setItem(STORAGE_KEY_NAME, myName);

  document.getElementById('overlay').style.display = 'none';
  document.getElementById('info-bar').style.display = 'block';
  initMap();
}

// Auto-join if returning user (localStorage persists across refreshes)
(function() {
  const savedName = localStorage.getItem(STORAGE_KEY_NAME);
  const savedId = localStorage.getItem(STORAGE_KEY_ID);
  if (savedName && savedId) {
    // Auto-join without showing the overlay
    myName = savedName;
    myGuestId = savedId;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('info-bar').style.display = 'block';
    // Wait for Google Maps script to load, then init
    waitForMaps(() => initMap());
  } else {
    nameInput.focus();
  }
})();

function waitForMaps(cb) {
  if (typeof google !== 'undefined' && google.maps) { cb(); return; }
  const check = setInterval(() => {
    if (typeof google !== 'undefined' && google.maps) {
      clearInterval(check);
      cb();
    }
  }, 100);
}

function initMap() {
  if (!map) {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: VENUE_LAT, lng: VENUE_LNG },
      zoom: 16,
      disableDefaultUI: true,
      zoomControl: true,
      styles: [
        { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
        { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#255763' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
        { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#283d6a' }] }
      ]
    });

    // Venue marker — destination pin
    new google.maps.Marker({
      position: { lat: VENUE_LAT, lng: VENUE_LNG },
      map: map,
      title: "{{VENUE_NAME}}",
      icon: {
        url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50"><path d="M20 0C9 0 0 9 0 20c0 15 20 30 20 30s20-15 20-30C40 9 31 0 20 0z" fill="#ff4444" stroke="#fff" stroke-width="2"/><circle cx="20" cy="18" r="8" fill="#fff"/><text x="20" y="22" text-anchor="middle" font-size="14" font-weight="bold" fill="#ff4444">&#9733;</text></svg>'),
        scaledSize: new google.maps.Size(40, 50),
        anchor: new google.maps.Point(20, 50)
      }
    });
  }

  connectWebSocket();
  startGeolocation();
}

function connectWebSocket() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    return;
  }
  clearTimeout(reconnectTimer);

  const url = `${WS_BASE}/ws/bounce/${SHARE_TOKEN}?guest_id=${encodeURIComponent(myGuestId)}&name=${encodeURIComponent(myName)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    showStatus('Connected');
    // Start keepalive
    clearInterval(pingInterval);
    pingInterval = setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.send('ping');
    }, 25000);
  };

  ws.onclose = () => {
    showStatus('Reconnecting...');
    clearInterval(pingInterval);
    reconnectTimer = setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => {};

  ws.onmessage = (event) => {
    if (event.data === 'pong') return;
    try {
      const msg = JSON.parse(event.data);
      handleMessage(msg);
    } catch(e) {}
  };
}

function handleMessage(msg) {
  switch(msg.type) {
    case 'initial_state':
      // Clear existing markers (reconnect may have stale data)
      Object.keys(markers).forEach(k => { if (k !== 'self') removeMarker(k); });
      (msg.app_users || []).forEach(u => upsertAppUser(u));
      (msg.guests || []).forEach(g => {
        if (g.guest_id !== myGuestId) upsertGuest(g);
      });
      updateCount();
      break;
    case 'location_shared':
      upsertAppUser(msg);
      updateCount();
      break;
    case 'location_sharing_stopped':
      removeMarker('user_' + msg.user_id);
      updateCount();
      break;
    case 'guest_location_shared':
      if (msg.guest_id !== myGuestId) {
        upsertGuest(msg);
        updateCount();
      }
      break;
    case 'guest_location_stopped':
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        updateCount();
      }
      break;
  }
}

function createPinSVG(color, letter) {
  return 'data:image/svg+xml,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">' +
    '<circle cx="18" cy="18" r="16" fill="' + color + '" stroke="#fff" stroke-width="3"/>' +
    '<text x="18" y="23" text-anchor="middle" font-size="15" font-weight="bold" fill="#fff">' + letter + '</text>' +
    '</svg>'
  );
}

function upsertAppUser(u) {
  const key = 'user_' + u.user_id;
  const pos = { lat: u.latitude, lng: u.longitude };
  const name = u.nickname || 'App User';
  if (markers[key]) {
    markers[key].setPosition(pos);
  } else {
    markers[key] = new google.maps.Marker({
      position: pos,
      map: map,
      title: name,
      icon: {
        url: createPinSVG('#9b59b6', (name[0] || '?').toUpperCase()),
        scaledSize: new google.maps.Size(36, 36),
        anchor: new google.maps.Point(18, 18)
      },
      label: { text: name, color: '#fff', fontSize: '11px', fontWeight: '600',
               className: 'map-label' }
    });
  }
}

function upsertGuest(g) {
  const key = 'guest_' + g.guest_id;
  const pos = { lat: g.latitude, lng: g.longitude };
  const name = g.display_name || 'Guest';
  if (markers[key]) {
    markers[key].setPosition(pos);
  } else {
    markers[key] = new google.maps.Marker({
      position: pos,
      map: map,
      title: name,
      icon: {
        url: createPinSVG('#2ecc71', (name[0] || '?').toUpperCase()),
        scaledSize: new google.maps.Size(36, 36),
        anchor: new google.maps.Point(18, 18)
      },
      label: { text: name, color: '#fff', fontSize: '11px', fontWeight: '600',
               className: 'map-label' }
    });
  }
}

function upsertSelf(lat, lng) {
  const key = 'self';
  const pos = { lat, lng };
  if (markers[key]) {
    markers[key].setPosition(pos);
  } else {
    markers[key] = new google.maps.Marker({
      position: pos,
      map: map,
      title: 'You',
      icon: {
        url: createPinSVG('#4a9eff', 'Y'),
        scaledSize: new google.maps.Size(36, 36),
        anchor: new google.maps.Point(18, 18)
      },
      label: { text: 'You', color: '#fff', fontSize: '11px', fontWeight: '600',
               className: 'map-label' }
    });
  }
}

function removeMarker(key) {
  if (markers[key]) {
    markers[key].setMap(null);
    delete markers[key];
  }
}

function updateCount() {
  const count = Object.keys(markers).filter(k => k !== 'self').length;
  const label = count === 1 ? '1 person sharing location' : count + ' people sharing location';
  document.getElementById('people-count').textContent = label;
}

function startGeolocation() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported');
    return;
  }
  // Clear old watch if any
  if (geoWatchId != null) navigator.geolocation.clearWatch(geoWatchId);

  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      upsertSelf(lat, lng);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
      }
    },
    (err) => { showStatus('Location access denied'); },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );
}

function showStatus(text) {
  const el = document.getElementById('status');
  el.textContent = text;
  el.style.display = 'block';
  clearTimeout(showStatus._timer);
  showStatus._timer = setTimeout(() => { el.style.display = 'none'; }, 4000);
}

// Handle page visibility changes — reconnect WS when page comes back
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && myGuestId && myName) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      connectWebSocket();
    }
    // Re-send current location immediately
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        upsertSelf(lat, lng);
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
        }
      }, () => {}, { enableHighAccuracy: true, maximumAge: 5000 });
    }
  }
});
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&callback=Function.prototype"></script>
</body>
</html>
