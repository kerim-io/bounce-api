<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>{{VENUE_NAME}} - Bounce</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#fff;height:100%;overflow:hidden;position:fixed;width:100%}
#map{width:100%;height:100%}
#overlay{position:fixed;inset:0;background:#111;display:flex;flex-direction:column;align-items:center;padding:60px 24px 40px;z-index:1000;overflow-y:auto}
.join-photos{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:32px}
.join-venue-pic,.join-inviter-pic{width:80px;height:80px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#333;flex-shrink:0}
.join-venue-pic{border:2px solid #fff}
.join-venue-pic img,.join-inviter-pic img{width:100%;height:100%;object-fit:cover}
.join-inviter-pic{border:2px solid #4a9eff}
.join-initial{font-size:28px;font-weight:bold;color:#fff}
.join-content{width:100%;max-width:380px}
.join-venue-name{font-size:22px;font-weight:700;color:#fff;margin-bottom:4px}
.join-venue-address{font-size:14px;color:#aaa;margin-bottom:16px}
.join-with{font-size:15px;color:#ccc;margin-bottom:24px}
.join-content input{width:100%;padding:14px;border-radius:10px;border:1px solid #333;background:#222;color:#fff;font-size:16px;outline:none;margin-bottom:16px}
.join-content input:focus{border-color:#4a9eff}
.join-content button{width:100%;padding:14px;border-radius:10px;border:none;background:#4a9eff;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.join-content button:disabled{opacity:.5;cursor:not-allowed}
#info-bar{position:fixed;top:0;left:0;right:0;background:rgba(17,17,17,.9);backdrop-filter:blur(10px);padding:12px 16px;z-index:500;display:none;border-bottom:1px solid #222;justify-content:space-between;align-items:center}
#info-bar .title{font-size:16px;font-weight:600}
#info-bar .sub{font-size:12px;color:#aaa}
#leave-btn{background:#ff4757;color:#fff;border:none;padding:6px 14px;border-radius:16px;font-size:13px;font-weight:600;cursor:pointer}
#status{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(17,17,17,.9);padding:8px 16px;border-radius:20px;font-size:12px;color:#aaa;z-index:500;display:none}
#loc-btn{position:fixed;bottom:24px;right:16px;width:44px;height:44px;border-radius:50%;background:#1a1a1a;border:1px solid #333;display:none;align-items:center;justify-content:center;z-index:500;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.4)}
#loc-btn svg{width:22px;height:22px;fill:#4a9eff}
/* Venue pin overlay */
.venue-pin{position:absolute;transform:translate(-50%,-100%);display:flex;flex-direction:column;align-items:center;cursor:pointer}
.venue-pin-circle{width:52px;height:52px;border-radius:50%;border:3px solid #4a9eff;overflow:hidden;background:#555;box-shadow:0 2px 6px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
.venue-pin-circle img{width:100%;height:100%;object-fit:cover}
.venue-pin-circle .initial{font-size:20px;font-weight:bold;color:#fff}
.venue-pin-label{margin-top:2px;background:rgba(0,0,0,.7);color:#fff;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;white-space:nowrap;max-width:100px;overflow:hidden;text-overflow:ellipsis}
.venue-pin-tail{width:2px;height:8px;background:#4a9eff;margin-top:-1px}
/* User pin overlay (for profile pic users) */
.user-pin{position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;cursor:pointer}
.user-pin-circle{width:52px;height:52px;border-radius:50%;border:3px solid #9b59b6;overflow:hidden;background:#555;box-shadow:0 2px 6px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
.user-pin-circle.guest{border-color:#2ecc71}
.user-pin-circle.self-pin{border-color:#4a9eff}
.user-pin-circle img{width:100%;height:100%;object-fit:cover}
.user-pin-circle .initial{font-size:22px;font-weight:bold;color:#fff}
/* Bottom sheet */
#bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;border-radius:20px 20px 0 0;z-index:600;transform:translateY(100%);transition:transform .3s ease;max-height:55vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
#bottom-sheet.open{transform:translateY(0)}
#bottom-sheet .handle{width:36px;height:4px;background:#444;border-radius:2px;margin:10px auto}
#bottom-sheet .sheet-content{padding:0 20px 24px}
#bottom-sheet .sheet-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
#bottom-sheet .sheet-photo{width:48px;height:48px;border-radius:50%;overflow:hidden;background:#333;flex-shrink:0;display:flex;align-items:center;justify-content:center}
#bottom-sheet .sheet-photo img{width:100%;height:100%;object-fit:cover}
#bottom-sheet .sheet-photo .initial{font-size:18px;font-weight:bold;color:#fff}
#bottom-sheet .sheet-info h2{font-size:18px;margin-bottom:2px}
#bottom-sheet .sheet-info p{font-size:13px;color:#aaa;margin:0}
#bottom-sheet .sheet-message{font-size:14px;color:#ccc;font-style:italic;margin-bottom:14px;padding:10px;background:#222;border-radius:10px}
#bottom-sheet .sheet-meta{font-size:12px;color:#888;display:flex;gap:16px;margin-bottom:14px}
#bottom-sheet .sheet-people{margin-top:4px}
#bottom-sheet .sheet-people h3{font-size:13px;color:#888;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
#bottom-sheet .person-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #222}
#bottom-sheet .person-row:last-child{border-bottom:none}
#bottom-sheet .person-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600;color:#fff;flex-shrink:0}
#bottom-sheet .person-name{font-size:14px}
#sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:550;display:none}
/* User sheet */
#user-sheet{position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;border-radius:20px 20px 0 0;z-index:700;transform:translateY(100%);transition:transform .3s ease;padding:20px 24px 32px}
#user-sheet.open{transform:translateY(0)}
#user-sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:650;display:none}
.us-close{position:absolute;top:12px;right:12px;width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:none;color:#fff;font-size:15px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.us-pic{width:72px;height:72px;border-radius:50%;overflow:hidden;background:#333;margin:0 auto 12px;display:flex;align-items:center;justify-content:center}
.us-pic img{width:100%;height:100%;object-fit:cover}
.us-pic .initial{font-size:28px;font-weight:bold;color:#fff}
.us-name{font-size:20px;font-weight:700;color:#fff;text-align:center;margin-bottom:16px}
.us-stats{display:flex;justify-content:center;gap:32px}
.us-stat{text-align:center}
.us-stat-num{font-size:18px;font-weight:700;color:#fff}
.us-stat-label{font-size:12px;color:#888;margin-top:2px}
.us-loading{text-align:center;color:#888;font-size:14px;padding:24px 0}
</style>
</head>
<body>

<div id="overlay">
  <div class="join-photos">
    <div class="join-venue-pic" id="join-venue-pic"></div>
    <div class="join-inviter-pic" id="join-inviter-pic"></div>
  </div>
  <div class="join-content">
    <div class="join-venue-name">{{VENUE_NAME}}</div>
    <div class="join-venue-address">{{VENUE_ADDRESS}}</div>
    <div class="join-with">with {{CREATOR_NAME}}</div>
    <input id="name-input" type="text" placeholder="Enter your name" maxlength="50" autocomplete="off">
    <button id="join-btn" disabled onclick="joinBounce()">Join Bounce</button>
  </div>
</div>

<div id="info-bar">
  <div>
    <div class="title">{{VENUE_NAME}}</div>
    <div class="sub" id="people-count"></div>
  </div>
  <button id="leave-btn" onclick="leaveBounce()">Leave</button>
</div>

<div id="status"></div>

<div id="map"></div>

<div id="loc-btn" onclick="requestLocation()">
  <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
</div>

<div id="sheet-backdrop" onclick="closeSheet()"></div>
<div id="bottom-sheet">
  <div class="handle"></div>
  <div class="sheet-content">
    <div class="sheet-header">
      <div class="sheet-photo" id="sheet-photo"></div>
      <div class="sheet-info">
        <h2 id="sheet-venue-name"></h2>
        <p id="sheet-venue-address"></p>
      </div>
    </div>
    <div class="sheet-message" id="sheet-message"></div>
    <div class="sheet-meta">
      <span id="sheet-creator"></span>
    </div>
    <div class="sheet-people">
      <h3>Sharing Location</h3>
      <div id="sheet-people-list"></div>
    </div>
  </div>
</div>

<div id="user-sheet-backdrop" onclick="closeUserSheet()"></div>
<div id="user-sheet">
  <button class="us-close" onclick="closeUserSheet()">&times;</button>
  <div class="us-pic" id="us-pic"></div>
  <div class="us-name" id="us-name"></div>
  <div class="us-stats">
    <div class="us-stat"><div class="us-stat-num" id="us-followers">-</div><div class="us-stat-label">Followers</div></div>
    <div class="us-stat"><div class="us-stat-num" id="us-following">-</div><div class="us-stat-label">Following</div></div>
  </div>
</div>

<script>
const VENUE_LAT = {{LATITUDE}};
const VENUE_LNG = {{LONGITUDE}};
const SHARE_TOKEN = "{{SHARE_TOKEN}}";
const WS_BASE = "{{WS_BASE}}";
const _RAW_VENUE_PHOTO = "{{VENUE_PHOTO_URL}}";
const VENUE_PHOTO_URL = _RAW_VENUE_PHOTO && !_RAW_VENUE_PHOTO.startsWith('data:') ? '/bounce/img-proxy?url=' + encodeURIComponent(_RAW_VENUE_PHOTO) : _RAW_VENUE_PHOTO;
const _RAW_CREATOR_PIC = "{{CREATOR_PROFILE_PIC}}";
const CREATOR_PIC_URL = _RAW_CREATOR_PIC && !_RAW_CREATOR_PIC.startsWith('data:') ? '/bounce/img-proxy?url=' + encodeURIComponent(_RAW_CREATOR_PIC) : _RAW_CREATOR_PIC;
const VENUE_NAME_STR = "{{VENUE_NAME}}";
const VENUE_ADDRESS_STR = "{{VENUE_ADDRESS}}";
const CREATOR_NAME_STR = "{{CREATOR_NAME}}";
const MESSAGE_STR = "{{MESSAGE}}";
const STORAGE_KEY_ID = 'bounce_guest_id_' + SHARE_TOKEN;
const STORAGE_KEY_NAME = 'bounce_guest_name_' + SHARE_TOKEN;

let map, ws, geoWatchId;
let markers = {};
let peopleData = {}; // track name/type for bottom sheet
let myGuestId;
let myName;
let reconnectTimer;
let pingInterval;

const nameInput = document.getElementById('name-input');
const joinBtn = document.getElementById('join-btn');

nameInput.addEventListener('input', () => {
  joinBtn.disabled = !nameInput.value.trim();
});

nameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && nameInput.value.trim()) joinBounce();
});

// Populate join screen photos
(function() {
  const venuePicEl = document.getElementById('join-venue-pic');
  if (VENUE_PHOTO_URL) {
    venuePicEl.innerHTML = '<img src="' + VENUE_PHOTO_URL + '" onerror="this.parentNode.innerHTML=\'<span class=join-initial>' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    venuePicEl.innerHTML = '<span class="join-initial">' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>';
  }
  const inviterPicEl = document.getElementById('join-inviter-pic');
  if (CREATOR_PIC_URL) {
    inviterPicEl.innerHTML = '<img src="' + CREATOR_PIC_URL + '" onerror="this.parentNode.innerHTML=\'<span class=join-initial>' + (CREATOR_NAME_STR[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    inviterPicEl.innerHTML = '<span class="join-initial">' + (CREATOR_NAME_STR[0] || '?').toUpperCase() + '</span>';
  }
})();

function leaveBounce() {
  if (geoWatchId != null) navigator.geolocation.clearWatch(geoWatchId);
  if (ws) ws.close();
  localStorage.removeItem(STORAGE_KEY_ID);
  localStorage.removeItem(STORAGE_KEY_NAME);
  location.reload();
}

function joinBounce() {
  myName = nameInput.value.trim();
  if (!myName) return;

  myGuestId = localStorage.getItem(STORAGE_KEY_ID);
  if (!myGuestId) {
    myGuestId = crypto.randomUUID();
    localStorage.setItem(STORAGE_KEY_ID, myGuestId);
  }
  localStorage.setItem(STORAGE_KEY_NAME, myName);

  document.getElementById('overlay').style.display = 'none';
  document.getElementById('info-bar').style.display = 'flex';
  waitForMaps(() => initMap());
}

// Auto-join if returning user
(function() {
  const savedName = localStorage.getItem(STORAGE_KEY_NAME);
  const savedId = localStorage.getItem(STORAGE_KEY_ID);
  if (savedName && savedId) {
    myName = savedName;
    myGuestId = savedId;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('info-bar').style.display = 'flex';
    waitForMaps(() => initMap());
  } else {
    nameInput.focus();
  }
})();

function waitForMaps(cb) {
  if (typeof google !== 'undefined' && google.maps) { cb(); return; }
  const check = setInterval(() => {
    if (typeof google !== 'undefined' && google.maps) {
      clearInterval(check);
      cb();
    }
  }, 100);
}

// Custom OverlayView for venue pin
let VenuePinOverlay;
function defineVenuePinOverlay() {
  VenuePinOverlay = class extends google.maps.OverlayView {
    constructor(position, photoUrl, name, onClick) {
      super();
      this.position = position;
      this.photoUrl = photoUrl;
      this.name = name;
      this.onClick = onClick;
      this.div = null;
    }
    onAdd() {
      this.div = document.createElement('div');
      this.div.className = 'venue-pin';
      this.div.addEventListener('click', (e) => {
        e.stopPropagation();
        if (this.onClick) this.onClick();
      });

      const circle = document.createElement('div');
      circle.className = 'venue-pin-circle';

      if (this.photoUrl) {
        const img = document.createElement('img');
        img.src = this.photoUrl;
        img.alt = this.name;
        img.onerror = () => {
          circle.innerHTML = '<span class="initial">' + (this.name[0] || '?').toUpperCase() + '</span>';
        };
        circle.appendChild(img);
      } else {
        circle.innerHTML = '<span class="initial">' + (this.name[0] || '?').toUpperCase() + '</span>';
      }

      const tail = document.createElement('div');
      tail.className = 'venue-pin-tail';

      const label = document.createElement('div');
      label.className = 'venue-pin-label';
      label.textContent = this.name;

      this.div.appendChild(circle);
      this.div.appendChild(tail);
      this.div.appendChild(label);

      const panes = this.getPanes();
      panes.overlayMouseTarget.appendChild(this.div);
    }
    draw() {
      const projection = this.getProjection();
      const pos = projection.fromLatLngToDivPixel(this.position);
      if (pos) {
        this.div.style.left = pos.x + 'px';
        this.div.style.top = pos.y + 'px';
      }
    }
    onRemove() {
      if (this.div) {
        this.div.parentNode.removeChild(this.div);
        this.div = null;
      }
    }
  };
}

function initMap() {
  if (!map) {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: VENUE_LAT, lng: VENUE_LNG },
      zoom: 16,
      disableDefaultUI: true,
      zoomControl: false,
      gestureHandling: 'greedy',
      styles: [
        { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
        { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#255763' }] },
        { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#98b7d6' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
        { featureType: 'poi', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.attraction', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.government', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.medical', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#1a3346' }] },
        { featureType: 'poi.park', elementType: 'labels', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.place_of_worship', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.sports_complex', stylers: [{ visibility: 'off' }] },
        { featureType: 'transit', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'administrative.land_parcel', stylers: [{ visibility: 'off' }] },
        { featureType: 'landscape.man_made', elementType: 'labels', stylers: [{ visibility: 'off' }] }
      ]
    });

    // Venue pin — tapping opens bottom sheet
    defineVenuePinOverlay();
    const venuePin = new VenuePinOverlay(
      new google.maps.LatLng(VENUE_LAT, VENUE_LNG),
      VENUE_PHOTO_URL,
      VENUE_NAME_STR,
      openSheet
    );
    venuePin.setMap(map);

    // Close sheet when tapping map
    map.addListener('click', () => { closeSheet(); closeUserSheet(); });
  }

  document.getElementById('loc-btn').style.display = 'flex';
  connectWebSocket();
  startGeolocation();
}

// Bottom sheet
function openSheet() {
  // Populate sheet
  const photoEl = document.getElementById('sheet-photo');
  if (VENUE_PHOTO_URL) {
    photoEl.innerHTML = '<img src="' + VENUE_PHOTO_URL + '" onerror="this.parentNode.innerHTML=\'<span class=initial>' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    photoEl.innerHTML = '<span class="initial">' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>';
  }
  document.getElementById('sheet-venue-name').textContent = VENUE_NAME_STR;
  document.getElementById('sheet-venue-address').textContent = VENUE_ADDRESS_STR;

  const msgEl = document.getElementById('sheet-message');
  if (MESSAGE_STR) {
    msgEl.textContent = '"' + MESSAGE_STR + '"';
    msgEl.style.display = 'block';
  } else {
    msgEl.style.display = 'none';
  }

  document.getElementById('sheet-creator').textContent = 'by ' + CREATOR_NAME_STR;

  // People list
  const listEl = document.getElementById('sheet-people-list');
  const colors = { app: '#9b59b6', guest: '#2ecc71', self: '#4a9eff' };
  let html = '';

  // Add self
  if (myName) {
    html += '<div class="person-row"><div class="person-avatar" style="background:' + colors.self + '">Y</div><div class="person-name">You (' + myName + ')</div></div>';
  }

  Object.keys(peopleData).forEach(key => {
    const p = peopleData[key];
    const color = p.type === 'app' ? colors.app : colors.guest;
    const initial = (p.name[0] || '?').toUpperCase();
    if (p.pic) {
      html += '<div class="person-row"><div class="person-avatar" style="border:2px solid ' + color + ';padding:0;overflow:hidden"><img src="' + p.pic + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.parentNode.style.background=\'' + color + '\';this.parentNode.innerHTML=\'' + initial + '\'"></div><div class="person-name">' + p.name + '</div></div>';
    } else {
      html += '<div class="person-row"><div class="person-avatar" style="background:' + color + '">' + initial + '</div><div class="person-name">' + p.name + '</div></div>';
    }
  });

  if (!html) {
    html = '<div style="color:#666;font-size:13px;padding:8px 0">No one else sharing yet</div>';
  }
  listEl.innerHTML = html;

  document.getElementById('sheet-backdrop').style.display = 'block';
  document.getElementById('bottom-sheet').classList.add('open');
}

function closeSheet() {
  document.getElementById('bottom-sheet').classList.remove('open');
  document.getElementById('sheet-backdrop').style.display = 'none';
}

function openUserSheet(userId) {
  const sheet = document.getElementById('user-sheet');
  const picEl = document.getElementById('us-pic');
  const nameEl = document.getElementById('us-name');
  const followersEl = document.getElementById('us-followers');
  const followingEl = document.getElementById('us-following');

  // Show immediately with cached data from peopleData
  const cached = peopleData['user_' + userId];
  if (cached && cached.pic) {
    picEl.innerHTML = '<img src="' + cached.pic + '" onerror="this.parentNode.innerHTML=\'<span class=initial>' + (cached.name[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    const letter = cached ? (cached.name[0] || '?').toUpperCase() : '?';
    picEl.innerHTML = '<span class="initial">' + letter + '</span>';
  }
  nameEl.textContent = cached ? cached.name : 'Loading...';
  followersEl.textContent = '-';
  followingEl.textContent = '-';

  document.getElementById('user-sheet-backdrop').style.display = 'block';
  sheet.classList.add('open');

  // Fetch full profile from server
  fetch('/bounce/share/' + SHARE_TOKEN + '/user/' + userId)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      nameEl.textContent = data.nickname;
      followersEl.textContent = data.followers_count;
      followingEl.textContent = data.following_count;
      if (data.profile_picture) {
        const url = proxyUrl(data.profile_picture);
        picEl.innerHTML = '<img src="' + url + '" onerror="this.parentNode.innerHTML=\'<span class=initial>' + (data.nickname[0] || '?').toUpperCase() + '</span>\'">';
      }
    })
    .catch(() => {});
}

function closeUserSheet() {
  document.getElementById('user-sheet').classList.remove('open');
  document.getElementById('user-sheet-backdrop').style.display = 'none';
}

function connectWebSocket() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    return;
  }
  clearTimeout(reconnectTimer);

  const url = `${WS_BASE}/ws/bounce/${SHARE_TOKEN}?guest_id=${encodeURIComponent(myGuestId)}&name=${encodeURIComponent(myName)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    showStatus('Connected');
    clearInterval(pingInterval);
    pingInterval = setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.send('ping');
    }, 25000);
  };

  ws.onclose = () => {
    showStatus('Reconnecting...');
    clearInterval(pingInterval);
    reconnectTimer = setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => {};

  ws.onmessage = (event) => {
    if (event.data === 'pong') return;
    try {
      const msg = JSON.parse(event.data);
      console.log('[bounce-ws]', msg.type, msg);
      handleMessage(msg);
    } catch(e) {}
  };
}

function handleMessage(msg) {
  switch(msg.type) {
    case 'initial_state':
      Object.keys(markers).forEach(k => { if (k !== 'self') removeMarker(k); });
      peopleData = {};
      (msg.app_users || []).forEach(u => upsertAppUser(u));
      (msg.guests || []).forEach(g => {
        if (g.guest_id !== myGuestId) upsertGuest(g);
      });
      updateCount();
      break;
    case 'location_shared':
      upsertAppUser(msg);
      updateCount();
      break;
    case 'location_sharing_stopped':
      removeMarker('user_' + msg.user_id);
      delete peopleData['user_' + msg.user_id];
      updateCount();
      break;
    case 'guest_location_shared':
      if (msg.guest_id !== myGuestId) {
        upsertGuest(msg);
        updateCount();
      }
      break;
    case 'guest_location_stopped':
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        delete peopleData['guest_' + msg.guest_id];
        updateCount();
      }
      break;
    case 'guest_left':
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        delete peopleData['guest_' + msg.guest_id];
        updateCount();
      }
      break;
  }
}

function createPinSVG(color, letter) {
  return 'data:image/svg+xml,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 52 52">' +
    '<circle cx="26" cy="26" r="23" fill="' + color + '" stroke="#fff" stroke-width="3"/>' +
    '<text x="26" y="33" text-anchor="middle" font-size="22" font-weight="bold" fill="#fff">' + letter + '</text>' +
    '</svg>'
  );
}

// Custom OverlayView for user pins with profile pictures
let UserPinOverlay;
function defineUserPinOverlay() {
  if (UserPinOverlay) return;
  UserPinOverlay = class extends google.maps.OverlayView {
    constructor(position, photoUrl, initial, borderColor, onClick) {
      super();
      this.position = position;
      this.photoUrl = photoUrl;
      this.initial = initial;
      this.borderColor = borderColor;
      this.onClick = onClick;
      this.div = null;
    }
    onAdd() {
      this.div = document.createElement('div');
      this.div.className = 'user-pin';
      if (this.onClick) {
        this.div.addEventListener('click', (e) => { e.stopPropagation(); this.onClick(); });
      }
      const circle = document.createElement('div');
      circle.className = 'user-pin-circle';
      circle.style.borderColor = this.borderColor;
      if (this.photoUrl) {
        const img = document.createElement('img');
        img.src = this.photoUrl;
        img.onerror = () => {
          circle.innerHTML = '<span class="initial">' + this.initial + '</span>';
        };
        circle.appendChild(img);
      } else {
        circle.innerHTML = '<span class="initial">' + this.initial + '</span>';
      }
      this.div.appendChild(circle);
      const panes = this.getPanes();
      panes.overlayMouseTarget.appendChild(this.div);
    }
    draw() {
      const projection = this.getProjection();
      const pos = projection.fromLatLngToDivPixel(this.position);
      if (pos) {
        this.div.style.left = pos.x + 'px';
        this.div.style.top = pos.y + 'px';
      }
    }
    setPosition(pos) {
      this.position = pos;
      this.draw();
    }
    onRemove() {
      if (this.div) { this.div.parentNode.removeChild(this.div); this.div = null; }
    }
  };
}

function createUserPin(lat, lng, photoUrl, initial, borderColor, onClick) {
  defineUserPinOverlay();
  const pin = new UserPinOverlay(
    new google.maps.LatLng(lat, lng),
    photoUrl, initial, borderColor, onClick
  );
  pin.setMap(map);
  return pin;
}

// Proxy external URLs through our backend to avoid CORS/CORP blocks
function proxyUrl(url) {
  if (!url) return null;
  if (url.startsWith('data:')) return url; // base64 is fine as-is
  return '/bounce/img-proxy?url=' + encodeURIComponent(url);
}

function upsertAppUser(u) {
  const key = 'user_' + u.user_id;
  const name = u.nickname || 'App User';
  const pic = proxyUrl(u.profile_picture) || null;
  peopleData[key] = { name: name, type: 'app', pic: pic, user_id: u.user_id };
  if (markers[key]) {
    markers[key].setPosition(new google.maps.LatLng(u.latitude, u.longitude));
  } else {
    const tapHandler = () => openUserSheet(u.user_id);
    if (pic) {
      markers[key] = createUserPin(u.latitude, u.longitude, pic, (name[0] || '?').toUpperCase(), '#9b59b6', tapHandler);
    } else {
      const marker = new google.maps.Marker({
        position: { lat: u.latitude, lng: u.longitude },
        map: map,
        title: name,
        icon: {
          url: createPinSVG('#9b59b6', (name[0] || '?').toUpperCase()),
          scaledSize: new google.maps.Size(52, 52),
          anchor: new google.maps.Point(26, 26)
        }
      });
      marker.addListener('click', tapHandler);
      markers[key] = marker;
    }
  }
}

function upsertGuest(g) {
  const key = 'guest_' + g.guest_id;
  const name = g.display_name || 'Guest';
  peopleData[key] = { name: name, type: 'guest' };
  if (markers[key]) {
    markers[key].setPosition(typeof markers[key].setPosition === 'function' && markers[key] instanceof google.maps.Marker
      ? { lat: g.latitude, lng: g.longitude }
      : new google.maps.LatLng(g.latitude, g.longitude));
  } else {
    markers[key] = new google.maps.Marker({
      position: { lat: g.latitude, lng: g.longitude },
      map: map,
      title: name,
      icon: {
        url: createPinSVG('#2ecc71', (name[0] || '?').toUpperCase()),
        scaledSize: new google.maps.Size(52, 52),
        anchor: new google.maps.Point(26, 26)
      }
    });
  }
}

function upsertSelf(lat, lng) {
  console.log('[bounce-geo] upsertSelf', lat, lng);
  const key = 'self';
  if (markers[key]) {
    if (markers[key] instanceof google.maps.Marker) {
      markers[key].setPosition({ lat, lng });
    } else {
      markers[key].setPosition(new google.maps.LatLng(lat, lng));
    }
  } else {
    const initial = myName ? myName[0].toUpperCase() : 'Y';
    markers[key] = new google.maps.Marker({
      position: { lat, lng },
      map: map,
      title: 'You',
      icon: {
        url: createPinSVG('#4a9eff', initial),
        scaledSize: new google.maps.Size(52, 52),
        anchor: new google.maps.Point(26, 26)
      }
    });
  }
}

function removeMarker(key) {
  if (markers[key]) {
    markers[key].setMap(null);
    delete markers[key];
  }
}

// Also update bottom sheet people list to show profile pics


function updateCount() {
  const count = Object.keys(markers).filter(k => k !== 'self').length;
  const label = count === 1 ? '1 person sharing location' : count + ' people sharing location';
  document.getElementById('people-count').textContent = label;
}

function startGeolocation() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported');
    return;
  }
  if (geoWatchId != null) navigator.geolocation.clearWatch(geoWatchId);

  // Get position immediately so pin shows right away
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      upsertSelf(pos.coords.latitude, pos.coords.longitude);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'guest_location', latitude: pos.coords.latitude, longitude: pos.coords.longitude }));
      }
    },
    (err) => { console.warn('[bounce-geo] getCurrentPosition error:', err.code, err.message); },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );

  // Then watch for continuous updates
  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      upsertSelf(lat, lng);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
      }
    },
    (err) => { showStatus('Location access denied'); },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );
}

function requestLocation() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported');
    return;
  }
  showStatus('Requesting location...');
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      upsertSelf(lat, lng);
      if (map) map.panTo({ lat, lng });
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
      }
      showStatus('Location updated');
      // Restart watch if it died
      startGeolocation();
    },
    (err) => {
      if (err.code === 1) {
        showStatus('Location blocked — enable in browser settings');
      } else {
        showStatus('Could not get location');
      }
    },
    { enableHighAccuracy: true, maximumAge: 0 }
  );
}

function showStatus(text) {
  const el = document.getElementById('status');
  el.textContent = text;
  el.style.display = 'block';
  clearTimeout(showStatus._timer);
  showStatus._timer = setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.addEventListener('visibilitychange', () => {
  if (!document.hidden && myGuestId && myName) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      connectWebSocket();
    }
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        upsertSelf(pos.coords.latitude, pos.coords.longitude);
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'guest_location', latitude: pos.coords.latitude, longitude: pos.coords.longitude }));
        }
      }, () => {}, { enableHighAccuracy: true, maximumAge: 5000 });
    }
  }
});
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&callback=Function.prototype"></script>
</body>
</html>
