<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>{{VENUE_NAME}} - Bounce</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#fff;height:100%;overflow:hidden;position:fixed;width:100%}
#map{width:100%;height:100%}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000}
.card{background:#1a1a1a;border-radius:16px;padding:32px;max-width:380px;width:90%;text-align:center}
.card h1{font-size:20px;margin-bottom:4px;color:#fff}
.card .venue{font-size:14px;color:#aaa;margin-bottom:6px}
.card .msg{font-size:15px;color:#ccc;margin-bottom:20px;font-style:italic}
.card .by{font-size:13px;color:#888;margin-bottom:20px}
.card input{width:100%;padding:14px;border-radius:10px;border:1px solid #333;background:#222;color:#fff;font-size:16px;outline:none;margin-bottom:16px}
.card input:focus{border-color:#4a9eff}
.card button{width:100%;padding:14px;border-radius:10px;border:none;background:#4a9eff;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.card button:disabled{opacity:.5;cursor:not-allowed}
#info-bar{position:fixed;top:0;left:0;right:0;background:rgba(17,17,17,.9);backdrop-filter:blur(10px);padding:12px 16px;z-index:500;display:none;border-bottom:1px solid #222}
#info-bar .title{font-size:16px;font-weight:600}
#info-bar .sub{font-size:12px;color:#aaa}
#status{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(17,17,17,.9);padding:8px 16px;border-radius:20px;font-size:12px;color:#aaa;z-index:500;display:none}
/* Venue pin overlay */
.venue-pin{position:absolute;transform:translate(-50%,-100%);pointer-events:none;display:flex;flex-direction:column;align-items:center}
.venue-pin-circle{width:52px;height:52px;border-radius:50%;border:3px solid #4a9eff;overflow:hidden;background:#555;box-shadow:0 2px 6px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
.venue-pin-circle img{width:100%;height:100%;object-fit:cover}
.venue-pin-circle .initial{font-size:20px;font-weight:bold;color:#fff}
.venue-pin-label{margin-top:2px;background:rgba(0,0,0,.7);color:#fff;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;white-space:nowrap;max-width:100px;overflow:hidden;text-overflow:ellipsis}
.venue-pin-tail{width:2px;height:8px;background:#4a9eff;margin-top:-1px}
</style>
</head>
<body>

<div id="overlay">
  <div class="card">
    <h1>{{VENUE_NAME}}</h1>
    <div class="venue">{{VENUE_ADDRESS}}</div>
    <div class="msg">{{MESSAGE}}</div>
    <div class="by">by {{CREATOR_NAME}}</div>
    <input id="name-input" type="text" placeholder="Enter your name" maxlength="50" autocomplete="off">
    <button id="join-btn" disabled onclick="joinBounce()">Join Map</button>
  </div>
</div>

<div id="info-bar">
  <div class="title">{{VENUE_NAME}}</div>
  <div class="sub" id="people-count"></div>
</div>

<div id="status"></div>

<div id="map"></div>

<script>
const VENUE_LAT = {{LATITUDE}};
const VENUE_LNG = {{LONGITUDE}};
const SHARE_TOKEN = "{{SHARE_TOKEN}}";
const WS_BASE = "{{WS_BASE}}";
const VENUE_PHOTO_URL = "{{VENUE_PHOTO_URL}}";
const VENUE_NAME_STR = "{{VENUE_NAME}}";
const STORAGE_KEY_ID = 'bounce_guest_id_' + SHARE_TOKEN;
const STORAGE_KEY_NAME = 'bounce_guest_name_' + SHARE_TOKEN;

let map, ws, geoWatchId;
let markers = {};
let myGuestId;
let myName;
let reconnectTimer;
let pingInterval;

const nameInput = document.getElementById('name-input');
const joinBtn = document.getElementById('join-btn');

nameInput.addEventListener('input', () => {
  joinBtn.disabled = !nameInput.value.trim();
});

nameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && nameInput.value.trim()) joinBounce();
});

function joinBounce() {
  myName = nameInput.value.trim();
  if (!myName) return;

  myGuestId = localStorage.getItem(STORAGE_KEY_ID);
  if (!myGuestId) {
    myGuestId = crypto.randomUUID();
    localStorage.setItem(STORAGE_KEY_ID, myGuestId);
  }
  localStorage.setItem(STORAGE_KEY_NAME, myName);

  document.getElementById('overlay').style.display = 'none';
  document.getElementById('info-bar').style.display = 'block';
  initMap();
}

// Auto-join if returning user
(function() {
  const savedName = localStorage.getItem(STORAGE_KEY_NAME);
  const savedId = localStorage.getItem(STORAGE_KEY_ID);
  if (savedName && savedId) {
    myName = savedName;
    myGuestId = savedId;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('info-bar').style.display = 'block';
    waitForMaps(() => initMap());
  } else {
    nameInput.focus();
  }
})();

function waitForMaps(cb) {
  if (typeof google !== 'undefined' && google.maps) { cb(); return; }
  const check = setInterval(() => {
    if (typeof google !== 'undefined' && google.maps) {
      clearInterval(check);
      cb();
    }
  }, 100);
}

// Custom OverlayView for venue pin (avoids CORS canvas issues with venue photo)
let VenuePinOverlay;
function defineVenuePinOverlay() {
  VenuePinOverlay = class extends google.maps.OverlayView {
    constructor(position, photoUrl, name) {
      super();
      this.position = position;
      this.photoUrl = photoUrl;
      this.name = name;
      this.div = null;
    }
    onAdd() {
      this.div = document.createElement('div');
      this.div.className = 'venue-pin';

      const circle = document.createElement('div');
      circle.className = 'venue-pin-circle';

      if (this.photoUrl) {
        const img = document.createElement('img');
        img.src = this.photoUrl;
        img.alt = this.name;
        img.onerror = () => {
          // Fallback to initial on load failure
          circle.innerHTML = '<span class="initial">' + (this.name[0] || '?').toUpperCase() + '</span>';
        };
        circle.appendChild(img);
      } else {
        circle.innerHTML = '<span class="initial">' + (this.name[0] || '?').toUpperCase() + '</span>';
      }

      const tail = document.createElement('div');
      tail.className = 'venue-pin-tail';

      const label = document.createElement('div');
      label.className = 'venue-pin-label';
      label.textContent = this.name;

      this.div.appendChild(circle);
      this.div.appendChild(tail);
      this.div.appendChild(label);

      const panes = this.getPanes();
      panes.overlayMouseTarget.appendChild(this.div);
    }
    draw() {
      const projection = this.getProjection();
      const pos = projection.fromLatLngToDivPixel(this.position);
      if (pos) {
        this.div.style.left = pos.x + 'px';
        this.div.style.top = pos.y + 'px';
      }
    }
    onRemove() {
      if (this.div) {
        this.div.parentNode.removeChild(this.div);
        this.div = null;
      }
    }
  };
}

function initMap() {
  if (!map) {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: VENUE_LAT, lng: VENUE_LNG },
      zoom: 16,
      disableDefaultUI: true,
      zoomControl: true,
      gestureHandling: 'greedy',
      styles: [
        { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
        { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#255763' }] },
        { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#98b7d6' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
        { featureType: 'poi', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.attraction', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.government', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.medical', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#1a3346' }] },
        { featureType: 'poi.park', elementType: 'labels', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.place_of_worship', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.sports_complex', stylers: [{ visibility: 'off' }] },
        { featureType: 'transit', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'administrative.land_parcel', stylers: [{ visibility: 'off' }] },
        { featureType: 'landscape.man_made', elementType: 'labels', stylers: [{ visibility: 'off' }] }
      ]
    });

    // Venue pin with photo (HTML overlay, no canvas/CORS issues)
    defineVenuePinOverlay();
    const venuePin = new VenuePinOverlay(
      new google.maps.LatLng(VENUE_LAT, VENUE_LNG),
      VENUE_PHOTO_URL,
      VENUE_NAME_STR
    );
    venuePin.setMap(map);
  }

  connectWebSocket();
  startGeolocation();
}

function connectWebSocket() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    return;
  }
  clearTimeout(reconnectTimer);

  const url = `${WS_BASE}/ws/bounce/${SHARE_TOKEN}?guest_id=${encodeURIComponent(myGuestId)}&name=${encodeURIComponent(myName)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    showStatus('Connected');
    clearInterval(pingInterval);
    pingInterval = setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.send('ping');
    }, 25000);
  };

  ws.onclose = () => {
    showStatus('Reconnecting...');
    clearInterval(pingInterval);
    reconnectTimer = setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => {};

  ws.onmessage = (event) => {
    if (event.data === 'pong') return;
    try {
      const msg = JSON.parse(event.data);
      console.log('[bounce-ws]', msg.type, msg);
      handleMessage(msg);
    } catch(e) {}
  };
}

function handleMessage(msg) {
  switch(msg.type) {
    case 'initial_state':
      Object.keys(markers).forEach(k => { if (k !== 'self') removeMarker(k); });
      (msg.app_users || []).forEach(u => upsertAppUser(u));
      (msg.guests || []).forEach(g => {
        if (g.guest_id !== myGuestId) upsertGuest(g);
      });
      updateCount();
      break;
    case 'location_shared':
      upsertAppUser(msg);
      updateCount();
      break;
    case 'location_sharing_stopped':
      removeMarker('user_' + msg.user_id);
      updateCount();
      break;
    case 'guest_location_shared':
      if (msg.guest_id !== myGuestId) {
        upsertGuest(msg);
        updateCount();
      }
      break;
    case 'guest_location_stopped':
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        updateCount();
      }
      break;
  }
}

function createPinSVG(color, letter) {
  return 'data:image/svg+xml,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 52 52">' +
    '<circle cx="26" cy="26" r="23" fill="' + color + '" stroke="#fff" stroke-width="3"/>' +
    '<text x="26" y="33" text-anchor="middle" font-size="22" font-weight="bold" fill="#fff">' + letter + '</text>' +
    '</svg>'
  );
}

function upsertAppUser(u) {
  const key = 'user_' + u.user_id;
  const pos = { lat: u.latitude, lng: u.longitude };
  const name = u.nickname || 'App User';
  if (markers[key]) {
    markers[key].setPosition(pos);
  } else {
    markers[key] = new google.maps.Marker({
      position: pos,
      map: map,
      title: name,
      icon: {
        url: createPinSVG('#9b59b6', (name[0] || '?').toUpperCase()),
        scaledSize: new google.maps.Size(52, 52),
        anchor: new google.maps.Point(26, 26)
      },
      label: { text: name, color: '#fff', fontSize: '11px', fontWeight: '600',
               className: 'map-label' }
    });
  }
}

function upsertGuest(g) {
  const key = 'guest_' + g.guest_id;
  const pos = { lat: g.latitude, lng: g.longitude };
  const name = g.display_name || 'Guest';
  if (markers[key]) {
    markers[key].setPosition(pos);
  } else {
    markers[key] = new google.maps.Marker({
      position: pos,
      map: map,
      title: name,
      icon: {
        url: createPinSVG('#2ecc71', (name[0] || '?').toUpperCase()),
        scaledSize: new google.maps.Size(52, 52),
        anchor: new google.maps.Point(26, 26)
      },
      label: { text: name, color: '#fff', fontSize: '11px', fontWeight: '600',
               className: 'map-label' }
    });
  }
}

function upsertSelf(lat, lng) {
  const key = 'self';
  const pos = { lat, lng };
  if (markers[key]) {
    markers[key].setPosition(pos);
  } else {
    markers[key] = new google.maps.Marker({
      position: pos,
      map: map,
      title: 'You',
      icon: {
        url: createPinSVG('#4a9eff', 'Y'),
        scaledSize: new google.maps.Size(52, 52),
        anchor: new google.maps.Point(26, 26)
      },
      label: { text: 'You', color: '#fff', fontSize: '11px', fontWeight: '600',
               className: 'map-label' }
    });
  }
}

function removeMarker(key) {
  if (markers[key]) {
    markers[key].setMap(null);
    delete markers[key];
  }
}

function updateCount() {
  const count = Object.keys(markers).filter(k => k !== 'self').length;
  const label = count === 1 ? '1 person sharing location' : count + ' people sharing location';
  document.getElementById('people-count').textContent = label;
}

function startGeolocation() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported');
    return;
  }
  if (geoWatchId != null) navigator.geolocation.clearWatch(geoWatchId);

  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      upsertSelf(lat, lng);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
      }
    },
    (err) => { showStatus('Location access denied'); },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );
}

function showStatus(text) {
  const el = document.getElementById('status');
  el.textContent = text;
  el.style.display = 'block';
  clearTimeout(showStatus._timer);
  showStatus._timer = setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.addEventListener('visibilitychange', () => {
  if (!document.hidden && myGuestId && myName) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      connectWebSocket();
    }
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        upsertSelf(lat, lng);
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
        }
      }, () => {}, { enableHighAccuracy: true, maximumAge: 5000 });
    }
  }
});
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&callback=Function.prototype"></script>
</body>
</html>
