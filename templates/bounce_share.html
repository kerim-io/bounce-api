<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>{{VENUE_NAME}} - Bounce</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{font-family:system-ui,-apple-system,sans-serif;background:#111;color:#fff;height:100%;overflow:hidden;position:fixed;width:100%}
#map{width:100%;height:100%}
#overlay{position:fixed;inset:0;background:#111;display:flex;flex-direction:column;align-items:flex-start;padding:60px 24px 40px;z-index:1000;overflow-y:auto}
.join-photos{display:flex;align-items:center;justify-content:flex-start;gap:16px;margin-bottom:32px}
.join-venue-pic,.join-inviter-pic{width:80px;height:80px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#333;flex-shrink:0}
.join-venue-pic{border:2px solid #fff}
.join-venue-pic img,.join-inviter-pic img{width:100%;height:100%;object-fit:cover}
.join-inviter-pic{border:2px solid #4a9eff}
.join-initial{font-size:28px;font-weight:bold;color:#fff}
.join-content{width:100%;max-width:380px}
.join-venue-name{font-size:22px;font-weight:700;color:#fff;margin-bottom:4px}
.join-venue-address{font-size:14px;color:#aaa;margin-bottom:16px}
.join-with{font-size:15px;color:#ccc;margin-bottom:24px}
.join-content input{width:100%;padding:14px;border-radius:10px;border:1px solid #333;background:#222;color:#fff;font-size:16px;outline:none;margin-bottom:16px}
.join-content input:focus{border-color:#4a9eff}
.join-content button{width:100%;padding:14px;border-radius:10px;border:none;background:#4a9eff;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.join-content button:disabled{opacity:.5;cursor:not-allowed}
.join-bounce-time{font-size:20px;color:#fff;font-weight:600;margin-bottom:16px}
#info-bar{position:fixed;top:0;left:0;right:0;background:rgba(17,17,17,.9);backdrop-filter:blur(10px);padding:12px 16px;z-index:500;display:none;border-bottom:1px solid #222;justify-content:space-between;align-items:center}
#info-bar .bar-left{display:flex;align-items:center;gap:10px;min-width:0}
#info-bar .bar-venue-pic{width:34px;height:34px;border-radius:50%;overflow:hidden;background:#333;flex-shrink:0;display:flex;align-items:center;justify-content:center;border:2px solid #4a9eff}
#info-bar .bar-venue-pic img{width:100%;height:100%;object-fit:cover}
#info-bar .bar-venue-pic .initial{font-size:14px;font-weight:bold;color:#fff}
#info-bar .title{font-size:16px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#info-bar .sub{font-size:12px;color:#aaa}
#info-bar .bar-right{display:flex;align-items:center;gap:12px;flex-shrink:0}
#info-bar .bar-time{font-size:13px;color:#ccc;font-weight:500;white-space:nowrap}
#leave-btn{width:36px;height:36px;border-radius:50%;background:#ff4757;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
#leave-btn svg{width:20px;height:20px;fill:#fff}
#status{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(17,17,17,.9);padding:8px 16px;border-radius:20px;font-size:12px;color:#aaa;z-index:500;display:none}
#loc-btn{position:fixed;top:60px;right:16px;padding:8px 14px;border-radius:20px;background:#1a1a1a;border:1px solid #333;display:none;align-items:center;gap:6px;z-index:500;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.4);font-family:system-ui,-apple-system,sans-serif;font-size:13px;font-weight:600;color:#4a9eff}
#loc-btn svg{width:18px;height:18px;fill:#4a9eff}
/* Venue pin overlay */
.venue-pin{position:absolute;transform:translate(-50%,-100%);display:flex;flex-direction:column;align-items:center;cursor:pointer}
.venue-pin-circle{width:52px;height:52px;border-radius:50%;border:3px solid #4a9eff;overflow:hidden;background:#555;box-shadow:0 2px 6px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;transition:transform .2s ease}
.venue-pin.active .venue-pin-circle{transform:scale(1.3)}
.venue-pin-circle img{width:100%;height:100%;object-fit:cover}
.venue-pin-circle .initial{font-size:20px;font-weight:bold;color:#fff;font-family:system-ui,-apple-system,sans-serif}
.venue-pin-label{margin-top:2px;background:rgba(0,0,0,.7);color:#fff;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;white-space:nowrap;max-width:100px;overflow:hidden;text-overflow:ellipsis}
.venue-pin-tail{width:2px;height:8px;background:#4a9eff;margin-top:-1px}
/* User pin overlay (for profile pic users) */
.user-pin{position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;cursor:pointer}
.user-pin-circle{width:52px;height:52px;border-radius:50%;border:3px solid #9b59b6;overflow:hidden;background:#555;box-shadow:0 2px 6px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;transition:transform .2s ease}
.user-pin.active .user-pin-circle{transform:scale(1.3)}
.user-pin-circle.guest{border-color:#2ecc71}
.user-pin-circle.self-pin{border-color:#4a9eff}
.user-pin-circle img{width:100%;height:100%;object-fit:cover}
.user-pin-circle .initial{font-size:22px;font-weight:bold;color:#fff;font-family:system-ui,-apple-system,sans-serif}
</style>
</head>
<body>

<div id="overlay">
  <div class="join-photos">
    <div class="join-venue-pic" id="join-venue-pic"></div>
    <div class="join-inviter-pic" id="join-inviter-pic"></div>
  </div>
  <div class="join-content">
    <div class="join-venue-name">{{VENUE_NAME}}</div>
    <div class="join-venue-address">{{VENUE_ADDRESS}}</div>
    <div class="join-with">with {{CREATOR_NAME}}</div>
    <div class="join-bounce-time" id="join-bounce-time"></div>
    <input id="name-input" type="text" placeholder="Enter your name" maxlength="50" autocomplete="off">
    <button id="join-btn" disabled onclick="joinBounce()">Join Bounce</button>
  </div>
</div>

<div id="info-bar">
  <div class="bar-left" onclick="openSheet()" style="cursor:pointer">
    <div class="bar-venue-pic" id="bar-venue-pic"></div>
    <div>
      <div class="title">{{VENUE_NAME}}</div>
      <div class="sub" id="people-count"></div>
    </div>
  </div>
  <div class="bar-right">
    <span class="bar-time" id="bar-time"></span>
    <button id="leave-btn" onclick="leaveBounce()"><svg viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5a2 2 0 00-2 2v4h2V5h14v14H5v-4H3v4a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg></button>
  </div>
</div>

<div id="status"></div>

<div id="map"></div>

<div id="loc-btn" onclick="requestLocation()">
  <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
  Share loc
</div>

{{VENUE_SHEET}}

{{USER_SHEET}}

<script>
const VENUE_LAT = {{LATITUDE}};
const VENUE_LNG = {{LONGITUDE}};
const SHARE_TOKEN = "{{SHARE_TOKEN}}";
const WS_BASE = "{{WS_BASE}}";
const _RAW_VENUE_PHOTO = "{{VENUE_PHOTO_URL}}";
const VENUE_PHOTO_URL = _RAW_VENUE_PHOTO && !_RAW_VENUE_PHOTO.startsWith('data:') ? '/bounce/img-proxy?url=' + encodeURIComponent(_RAW_VENUE_PHOTO) : _RAW_VENUE_PHOTO;
const _RAW_CREATOR_PIC = "{{CREATOR_PROFILE_PIC}}";
const CREATOR_PIC_URL = _RAW_CREATOR_PIC && !_RAW_CREATOR_PIC.startsWith('data:') ? '/bounce/img-proxy?url=' + encodeURIComponent(_RAW_CREATOR_PIC) : _RAW_CREATOR_PIC;
const VENUE_NAME_STR = "{{VENUE_NAME}}";
const VENUE_ADDRESS_STR = "{{VENUE_ADDRESS}}";
const CREATOR_NAME_STR = "{{CREATOR_NAME}}";
const MESSAGE_STR = "{{MESSAGE}}";
const BOUNCE_TIME = "{{BOUNCE_TIME}}";
const IS_NOW = {{IS_NOW}};
const STORAGE_KEY_ID = 'bounce_guest_id_' + SHARE_TOKEN;
const STORAGE_KEY_NAME = 'bounce_guest_name_' + SHARE_TOKEN;

let map, ws, geoWatchId;
let markers = {};
let peopleData = {}; // track name/type for bottom sheet
let activePinEl = null; // currently popped pin element
let venuePinRef = null; // reference to venue pin overlay
let myGuestId;
let myName;
let reconnectTimer;
let pingInterval;
let locationInterval; // periodic fallback for background location
let wakeLock = null;

const nameInput = document.getElementById('name-input');
const joinBtn = document.getElementById('join-btn');

nameInput.addEventListener('input', () => {
  joinBtn.disabled = !nameInput.value.trim();
});

nameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && nameInput.value.trim()) joinBounce();
});

// Populate join screen photos
(function() {
  const venuePicEl = document.getElementById('join-venue-pic');
  if (VENUE_PHOTO_URL) {
    venuePicEl.innerHTML = '<img src="' + VENUE_PHOTO_URL + '" onerror="this.parentNode.innerHTML=\'<span class=join-initial>' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    venuePicEl.innerHTML = '<span class="join-initial">' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>';
  }
  const inviterPicEl = document.getElementById('join-inviter-pic');
  if (CREATOR_PIC_URL) {
    inviterPicEl.innerHTML = '<img src="' + CREATOR_PIC_URL + '" onerror="this.parentNode.innerHTML=\'<span class=join-initial>' + (CREATOR_NAME_STR[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    inviterPicEl.innerHTML = '<span class="join-initial">' + (CREATOR_NAME_STR[0] || '?').toUpperCase() + '</span>';
  }
})();

// Format bounce time — "Today 7pm" if today, else "Sat, Feb 7, 7pm"
function formatBounceTime(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '';
  const now = new Date();
  const isToday = d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
  let h = d.getHours(); const m = d.getMinutes();
  const ampm = h >= 12 ? 'pm' : 'am';
  h = h % 12 || 12;
  const timeStr = m === 0 ? h + ampm : h + ':' + String(m).padStart(2,'0') + ampm;
  if (isToday) return 'Today ' + timeStr;
  const opts = { weekday: 'short', month: 'short', day: 'numeric' };
  return d.toLocaleDateString(undefined, opts) + ', ' + timeStr;
}
(function() {
  const txt = formatBounceTime(BOUNCE_TIME);
  if (txt) document.getElementById('join-bounce-time').textContent = txt;
  // Also set time in the map header bar
  if (txt) document.getElementById('bar-time').textContent = txt;
})();

// Populate venue pic in header bar
(function() {
  const el = document.getElementById('bar-venue-pic');
  const initial = (VENUE_NAME_STR[0] || '?').toUpperCase();
  if (VENUE_PHOTO_URL) {
    el.innerHTML = '<img src="' + VENUE_PHOTO_URL + '" onerror="this.parentNode.innerHTML=\'<span class=initial>' + initial + '</span>\'">';
  } else {
    el.innerHTML = '<span class="initial">' + initial + '</span>';
  }
})();

function leaveBounce() {
  if (geoWatchId != null) navigator.geolocation.clearWatch(geoWatchId);
  clearInterval(locationInterval);
  // Tell backend this is an explicit leave (not just a disconnect)
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'guest_leave' }));
  }
  if (ws) ws.close();
  localStorage.removeItem(STORAGE_KEY_ID);
  localStorage.removeItem(STORAGE_KEY_NAME);
  location.reload();
}

function joinBounce() {
  myName = nameInput.value.trim();
  if (!myName) return;

  myGuestId = localStorage.getItem(STORAGE_KEY_ID);
  if (!myGuestId) {
    myGuestId = crypto.randomUUID();
    localStorage.setItem(STORAGE_KEY_ID, myGuestId);
  }
  localStorage.setItem(STORAGE_KEY_NAME, myName);

  document.getElementById('overlay').style.display = 'none';
  document.getElementById('info-bar').style.display = 'flex';
  document.getElementById('chat-panel').style.display = 'flex';
  waitForMaps(() => initMap());
}

// Auto-join if returning user (deferred until full DOM is parsed,
// because #chat-panel is injected after this script block)
function tryAutoJoin() {
  const savedName = localStorage.getItem(STORAGE_KEY_NAME);
  const savedId = localStorage.getItem(STORAGE_KEY_ID);
  if (savedName && savedId) {
    myName = savedName;
    myGuestId = savedId;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('info-bar').style.display = 'flex';
    document.getElementById('chat-panel').style.display = 'flex';
    waitForMaps(() => initMap());
  } else {
    nameInput.focus();
  }
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', tryAutoJoin);
} else {
  tryAutoJoin();
}

function waitForMaps(cb) {
  if (typeof google !== 'undefined' && google.maps) { cb(); return; }
  const check = setInterval(() => {
    if (typeof google !== 'undefined' && google.maps) {
      clearInterval(check);
      cb();
    }
  }, 100);
}

// Custom OverlayView for venue pin
let VenuePinOverlay;
function defineVenuePinOverlay() {
  VenuePinOverlay = class extends google.maps.OverlayView {
    constructor(position, photoUrl, name, onClick) {
      super();
      this.position = position;
      this.photoUrl = photoUrl;
      this.name = name;
      this.onClick = onClick;
      this.pixelOffsetX = 0;
      this.div = null;
    }
    onAdd() {
      this.div = document.createElement('div');
      this.div.className = 'venue-pin';
      this.div.addEventListener('click', (e) => {
        e.stopPropagation();
        if (this.onClick) this.onClick();
      });

      const circle = document.createElement('div');
      circle.className = 'venue-pin-circle';

      if (this.photoUrl) {
        const img = document.createElement('img');
        img.src = this.photoUrl;
        img.alt = this.name;
        img.onerror = () => {
          circle.innerHTML = '<span class="initial">' + (this.name[0] || '?').toUpperCase() + '</span>';
        };
        circle.appendChild(img);
      } else {
        circle.innerHTML = '<span class="initial">' + (this.name[0] || '?').toUpperCase() + '</span>';
      }

      const tail = document.createElement('div');
      tail.className = 'venue-pin-tail';

      const label = document.createElement('div');
      label.className = 'venue-pin-label';
      label.textContent = this.name;

      this.div.appendChild(circle);
      this.div.appendChild(tail);
      this.div.appendChild(label);

      const panes = this.getPanes();
      panes.overlayMouseTarget.appendChild(this.div);
    }
    draw() {
      if (!this.div) return;
      const projection = this.getProjection();
      if (!projection) return;
      const pos = projection.fromLatLngToDivPixel(this.position);
      if (pos) {
        this.div.style.left = (pos.x + this.pixelOffsetX) + 'px';
        this.div.style.top = pos.y + 'px';
      }
    }
    setPixelOffsetX(ox) {
      this.pixelOffsetX = ox;
      this.draw();
    }
    onRemove() {
      if (this.div) {
        this.div.parentNode.removeChild(this.div);
        this.div = null;
      }
    }
  };
}

function initMap() {
  if (!map) {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: VENUE_LAT, lng: VENUE_LNG },
      zoom: 16,
      disableDefaultUI: true,
      zoomControl: false,
      gestureHandling: 'greedy',
      styles: [
        { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
        { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#255763' }] },
        { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#98b7d6' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
        { featureType: 'poi', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.attraction', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.government', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.medical', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#1a3346' }] },
        { featureType: 'poi.park', elementType: 'labels', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.place_of_worship', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.sports_complex', stylers: [{ visibility: 'off' }] },
        { featureType: 'transit', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'administrative.land_parcel', stylers: [{ visibility: 'off' }] },
        { featureType: 'landscape.man_made', elementType: 'labels', stylers: [{ visibility: 'off' }] }
      ]
    });

    // Venue pin — tapping opens bottom sheet
    defineVenuePinOverlay();
    const venuePin = new VenuePinOverlay(
      new google.maps.LatLng(VENUE_LAT, VENUE_LNG),
      VENUE_PHOTO_URL,
      VENUE_NAME_STR,
      openSheet
    );
    venuePin.setMap(map);
    venuePinRef = venuePin;

    // Close sheet when tapping map
    map.addListener('click', () => { closeSheet(); closeUserSheet(); });
  }

  document.getElementById('loc-btn').style.display = 'flex';
  connectWebSocket();
  startGeolocation();
}

function connectWebSocket() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    return;
  }
  clearTimeout(reconnectTimer);

  const url = `${WS_BASE}/ws/bounce/${SHARE_TOKEN}?guest_id=${encodeURIComponent(myGuestId)}&name=${encodeURIComponent(myName)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    showStatus('Connected');
    clearInterval(pingInterval);
    pingInterval = setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.send('ping');
    }, 25000);
  };

  ws.onclose = () => {
    showStatus('Reconnecting...');
    clearInterval(pingInterval);
    reconnectTimer = setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => {};

  ws.onmessage = (event) => {
    if (event.data === 'pong') return;
    try {
      const msg = JSON.parse(event.data);
      console.log('[bounce-ws]', msg.type, msg);
      handleMessage(msg);
    } catch(e) {}
  };
}

function handleMessage(msg) {
  switch(msg.type) {
    case 'initial_state':
      Object.keys(markers).forEach(k => { if (k !== 'self') removeMarker(k); });
      peopleData = {};
      (msg.app_users || []).forEach(u => upsertAppUser(u));
      (msg.guests || []).forEach(g => {
        if (g.guest_id !== myGuestId) upsertGuest(g);
      });
      updateCount();
      break;
    case 'location_shared':
      upsertAppUser(msg);
      updateCount();
      break;
    case 'location_sharing_stopped':
      removeMarker('user_' + msg.user_id);
      delete peopleData['user_' + msg.user_id];
      updateCount();
      break;
    case 'guest_location_shared':
      if (msg.guest_id !== myGuestId) {
        upsertGuest(msg);
        updateCount();
      }
      break;
    case 'guest_location_stopped':
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        delete peopleData['guest_' + msg.guest_id];
        updateCount();
      }
      break;
    case 'guest_disconnected':
      // Guest browser went to background — remove their map pin but don't forget them
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        updateCount();
      }
      break;
    case 'guest_left':
      // Guest explicitly left — fully remove
      if (msg.guest_id !== myGuestId) {
        removeMarker('guest_' + msg.guest_id);
        delete peopleData['guest_' + msg.guest_id];
        updateCount();
      }
      break;
  }
}

function createPinSVG(color, letter) {
  return 'data:image/svg+xml,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 52 52">' +
    '<circle cx="26" cy="26" r="23" fill="' + color + '" stroke="#fff" stroke-width="3"/>' +
    '<text x="26" y="33" text-anchor="middle" font-family="system-ui,sans-serif" font-size="22" font-weight="bold" fill="#fff">' + letter + '</text>' +
    '</svg>'
  );
}

// Custom OverlayView for user pins with profile pictures
let UserPinOverlay;
function defineUserPinOverlay() {
  if (UserPinOverlay) return;
  UserPinOverlay = class extends google.maps.OverlayView {
    constructor(position, photoUrl, initial, borderColor, onClick, pixelOffsetX, zIndex) {
      super();
      this.position = position;
      this.photoUrl = photoUrl;
      this.initial = initial;
      this.borderColor = borderColor;
      this.onClick = onClick;
      this.pixelOffsetX = pixelOffsetX || 0;
      this.zIndex = zIndex || 0;
      this.div = null;
    }
    onAdd() {
      this.div = document.createElement('div');
      this.div.className = 'user-pin';
      this.div.style.zIndex = this.zIndex;
      if (this.onClick) {
        this.div.addEventListener('click', (e) => { e.stopPropagation(); this.onClick(); });
      }
      const circle = document.createElement('div');
      circle.className = 'user-pin-circle';
      circle.style.borderColor = this.borderColor;
      if (this.photoUrl) {
        const img = document.createElement('img');
        img.src = this.photoUrl;
        img.onerror = () => {
          circle.innerHTML = '<span class="initial">' + this.initial + '</span>';
        };
        circle.appendChild(img);
      } else {
        circle.innerHTML = '<span class="initial">' + this.initial + '</span>';
      }
      this.div.appendChild(circle);
      const panes = this.getPanes();
      panes.overlayMouseTarget.appendChild(this.div);
    }
    draw() {
      if (!this.div) return;
      const projection = this.getProjection();
      if (!projection) return;
      const pos = projection.fromLatLngToDivPixel(this.position);
      if (pos) {
        this.div.style.left = (pos.x + this.pixelOffsetX) + 'px';
        this.div.style.top = pos.y + 'px';
      }
    }
    setPosition(pos) {
      this.position = pos;
      this.draw();
    }
    setPixelOffsetX(ox) {
      this.pixelOffsetX = ox;
      this.draw();
    }
    onRemove() {
      if (this.div) { this.div.parentNode.removeChild(this.div); this.div = null; }
    }
  };
}

function createUserPin(lat, lng, photoUrl, initial, borderColor, onClick, pixelOffsetX, zIndex) {
  defineUserPinOverlay();
  const pin = new UserPinOverlay(
    new google.maps.LatLng(lat, lng),
    photoUrl, initial, borderColor, onClick, pixelOffsetX, zIndex
  );
  pin.setMap(map);
  return pin;
}

// Track real positions for collision detection (lat/lng before any offset)
var pinPositions = {}; // key -> {lat, lng}
var PIN_SIZE = 52;
var PIN_OVERLAP = 5;
var PIN_STEP = PIN_SIZE - PIN_OVERLAP;
var CLUSTER_THRESHOLD = 0.00015; // lat+lng delta to count as same spot

// Full relayout: find all clusters and symmetrically spread every pin
function relayoutPins() {
  // Build list of all pin keys + positions (including venue)
  var all = [];
  all.push({ key: 'venue', lat: VENUE_LAT, lng: VENUE_LNG });
  Object.keys(pinPositions).forEach(function(k) {
    var p = pinPositions[k];
    all.push({ key: k, lat: p.lat, lng: p.lng });
  });

  // Find clusters via greedy grouping
  var assigned = {};
  var clusters = [];
  for (var i = 0; i < all.length; i++) {
    if (assigned[all[i].key]) continue;
    var cluster = [all[i]];
    assigned[all[i].key] = true;
    for (var j = i + 1; j < all.length; j++) {
      if (assigned[all[j].key]) continue;
      // Check if close to any member of this cluster
      for (var c = 0; c < cluster.length; c++) {
        if (Math.abs(all[j].lat - cluster[c].lat) + Math.abs(all[j].lng - cluster[c].lng) < CLUSTER_THRESHOLD) {
          cluster.push(all[j]);
          assigned[all[j].key] = true;
          break;
        }
      }
    }
    clusters.push(cluster);
  }

  // Apply offsets per cluster
  clusters.forEach(function(cluster) {
    var n = cluster.length;
    for (var i = 0; i < n; i++) {
      var ox = n > 1 ? (i - (n - 1) / 2) * PIN_STEP : 0;
      var zIdx = i;
      var key = cluster[i].key;
      if (key === 'venue') {
        if (venuePinRef && typeof venuePinRef.setPixelOffsetX === 'function') {
          venuePinRef.setPixelOffsetX(ox);
          if (venuePinRef.div) venuePinRef.div.style.zIndex = zIdx;
        }
      } else if (markers[key]) {
        if (typeof markers[key].setPixelOffsetX === 'function') markers[key].setPixelOffsetX(ox);
        if (markers[key].div) markers[key].div.style.zIndex = zIdx;
      }
    }
  });
}

// Haversine distance between two points in meters
function haversineDist(lat1, lng1, lat2, lng2) {
  var R = 6371000;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLng/2) * Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function formatDist(m) {
  if (m < 1000) return Math.round(m) + 'm';
  return (m / 1000).toFixed(1) + 'km';
}

// Deactivate any currently popped pin
function deactivatePin() {
  if (activePinEl) { activePinEl.classList.remove('active'); activePinEl = null; }
}

// Proxy external URLs through our backend to avoid CORS/CORP blocks
function proxyUrl(url) {
  if (!url) return null;
  if (url.startsWith('data:')) return url; // base64 is fine as-is
  return '/bounce/img-proxy?url=' + encodeURIComponent(url);
}

function upsertAppUser(u) {
  const key = 'user_' + u.user_id;
  const name = u.nickname || 'App User';
  const pic = proxyUrl(u.profile_picture) || null;
  peopleData[key] = { name: name, type: 'app', pic: pic, user_id: u.user_id };
  pinPositions[key] = { lat: u.latitude, lng: u.longitude };
  if (markers[key]) {
    markers[key].setPosition(new google.maps.LatLng(u.latitude, u.longitude));
  } else {
    const tapHandler = () => openUserSheet(u.user_id);
    markers[key] = createUserPin(u.latitude, u.longitude, pic, (name[0] || '?').toUpperCase(), '#9b59b6', tapHandler, 0, 0);
  }
  relayoutPins();
}

function upsertGuest(g) {
  const key = 'guest_' + g.guest_id;
  const name = g.display_name || 'Guest';
  peopleData[key] = { name: name, type: 'guest' };
  pinPositions[key] = { lat: g.latitude, lng: g.longitude };
  if (markers[key]) {
    markers[key].setPosition(new google.maps.LatLng(g.latitude, g.longitude));
  } else {
    const tapHandler = () => openGuestUserSheet(name);
    markers[key] = createUserPin(g.latitude, g.longitude, null, (name[0] || '?').toUpperCase(), '#2ecc71', tapHandler, 0, 0);
  }
  relayoutPins();
}

function upsertSelf(lat, lng) {
  console.log('[bounce-geo] upsertSelf', lat, lng);
  const key = 'self';
  pinPositions[key] = { lat: lat, lng: lng };
  if (markers[key]) {
    markers[key].setPosition(new google.maps.LatLng(lat, lng));
  } else {
    const initial = myName ? myName[0].toUpperCase() : 'Y';
    markers[key] = createUserPin(lat, lng, null, initial, '#4a9eff', null, 0, 0);
  }
  relayoutPins();
}

function removeMarker(key) {
  if (markers[key]) {
    markers[key].setMap(null);
    delete markers[key];
  }
  delete pinPositions[key];
  relayoutPins();
}

// Also update bottom sheet people list to show profile pics


function updateCount() {
  const count = Object.keys(markers).filter(k => k !== 'self').length;
  const label = count === 1 ? '1 person sharing location' : count + ' people sharing location';
  document.getElementById('people-count').textContent = label;
}

function sendLocation(lat, lng) {
  upsertSelf(lat, lng);
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
  }
}

function startGeolocation() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported');
    return;
  }
  if (geoWatchId != null) navigator.geolocation.clearWatch(geoWatchId);
  clearInterval(locationInterval);

  // Get position immediately so pin shows right away
  navigator.geolocation.getCurrentPosition(
    (pos) => sendLocation(pos.coords.latitude, pos.coords.longitude),
    (err) => { console.warn('[bounce-geo] getCurrentPosition error:', err.code, err.message); },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );

  // Continuous watch
  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => sendLocation(pos.coords.latitude, pos.coords.longitude),
    (err) => { showStatus('Location access denied'); },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );

  // Periodic fallback — fires even when watchPosition stalls in background
  locationInterval = setInterval(() => {
    navigator.geolocation.getCurrentPosition(
      (pos) => sendLocation(pos.coords.latitude, pos.coords.longitude),
      () => {},
      { enableHighAccuracy: true, maximumAge: 10000 }
    );
  }, 10000);

  // Try to keep screen awake so location keeps streaming
  acquireWakeLock();
}

async function acquireWakeLock() {
  if (!('wakeLock' in navigator)) return;
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', () => { wakeLock = null; });
  } catch(e) {}
}

function requestLocation() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported');
    return;
  }
  showStatus('Requesting location...');
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      upsertSelf(lat, lng);
      if (map) map.panTo({ lat, lng });
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'guest_location', latitude: lat, longitude: lng }));
      }
      showStatus('Location updated');
      // Restart watch if it died
      startGeolocation();
    },
    (err) => {
      if (err.code === 1) {
        showStatus('Location blocked — enable in browser settings');
      } else {
        showStatus('Could not get location');
      }
    },
    { enableHighAccuracy: true, maximumAge: 0 }
  );
}

function showStatus(text) {
  const el = document.getElementById('status');
  el.textContent = text;
  el.style.display = 'block';
  clearTimeout(showStatus._timer);
  showStatus._timer = setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.addEventListener('visibilitychange', () => {
  if (!document.hidden && myGuestId && myName) {
    // Reconnect WS if it died in background
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      connectWebSocket();
    }
    // Immediately blast current position
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => sendLocation(pos.coords.latitude, pos.coords.longitude),
        () => {}, { enableHighAccuracy: true, maximumAge: 5000 }
      );
    }
    // Re-acquire wake lock (released when page hidden on some browsers)
    acquireWakeLock();
  }
});
</script>

{{CHAT_PANEL}}

<script async src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&callback=Function.prototype"></script>
</body>
</html>
