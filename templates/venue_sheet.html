<style>
#bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;border-radius:20px 20px 0 0;z-index:600;transform:translateY(100%);transition:transform .3s ease;max-height:55vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
#bottom-sheet.open{transform:translateY(0)}
#bottom-sheet .handle{width:36px;height:4px;background:#444;border-radius:2px;margin:10px auto}
#bottom-sheet .sheet-content{padding:0 20px 24px;position:relative}
#bottom-sheet .sheet-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
#bottom-sheet .sheet-photo{width:48px;height:48px;border-radius:50%;overflow:hidden;background:#333;flex-shrink:0;display:flex;align-items:center;justify-content:center}
#bottom-sheet .sheet-photo img{width:100%;height:100%;object-fit:cover}
#bottom-sheet .sheet-photo .initial{font-size:18px;font-weight:bold;color:#fff}
#bottom-sheet .sheet-info h2{font-size:18px;margin-bottom:2px}
#bottom-sheet .sheet-info p{font-size:13px;color:#aaa;margin:0}
#bottom-sheet .sheet-message{font-size:14px;color:#ccc;font-style:italic;margin-bottom:14px;padding:10px;background:#222;border-radius:10px}
#bottom-sheet .sheet-meta{font-size:12px;color:#888;display:flex;gap:16px;margin-bottom:14px}
#bottom-sheet .sheet-people{margin-top:4px}
#bottom-sheet .sheet-people h3{font-size:13px;color:#888;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
#bottom-sheet .person-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #222}
#bottom-sheet .person-row:last-child{border-bottom:none}
#bottom-sheet .person-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600;color:#fff;flex-shrink:0}
#bottom-sheet .person-name{font-size:14px;flex:1}
#bottom-sheet .person-dist{font-size:12px;color:#888;white-space:nowrap}
#bottom-sheet .person-status{font-size:11px;color:#555;white-space:nowrap}
.vs-close{position:absolute;top:0;right:0;width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:none;color:#fff;font-size:15px;display:flex;align-items:center;justify-content:center;cursor:pointer}
#sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:550;display:none}
</style>

<div id="sheet-backdrop" onclick="closeSheet()"></div>
<div id="bottom-sheet">
  <div class="handle"></div>
  <div class="sheet-content">
    <button class="vs-close" onclick="closeSheet()">&times;</button>
    <div class="sheet-header">
      <div class="sheet-photo" id="sheet-photo"></div>
      <div class="sheet-info">
        <h2 id="sheet-venue-name"></h2>
        <p id="sheet-venue-address"></p>
      </div>
    </div>
    <div class="sheet-message" id="sheet-message"></div>
    <div class="sheet-meta">
      <span id="sheet-creator"></span>
    </div>
    <div class="sheet-people">
      <h3>Attendees</h3>
      <div id="sheet-people-list"></div>
    </div>
  </div>
</div>

<script>
function buildAttendeeRow(a, colors) {
  var isGuest = a.type === 'guest';
  var color = isGuest ? colors.guest : colors.app;
  var initial = (a.nickname[0] || '?').toUpperCase();
  var tap, key;

  if (isGuest) {
    key = 'guest_' + a.guest_id;
    tap = 'onclick="closeSheet();openGuestUserSheet(\'' + a.nickname.replace(/'/g, "\\'") + '\')"';
  } else {
    key = 'user_' + a.user_id;
    tap = 'onclick="closeSheet();openUserSheet(' + a.user_id + ')"';
  }

  // Distance if sharing location, otherwise status text
  var pos = pinPositions[key];
  var rightHtml = '';
  if (pos) {
    rightHtml = '<div class="person-dist">' + formatDist(haversineDist(pos.lat, pos.lng, VENUE_LAT, VENUE_LNG)) + '</div>';
  } else if (isGuest && !a.is_connected) {
    rightHtml = '<div class="person-status">offline</div>';
  }

  var pic = !isGuest ? proxyUrl(a.profile_picture) : null;
  var avatarHtml;
  if (pic) {
    avatarHtml = '<div class="person-avatar" style="border:2px solid ' + color + ';padding:0;overflow:hidden"><img src="' + pic + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.parentNode.style.background=\'' + color + '\';this.parentNode.innerHTML=\'' + initial + '\'"></div>';
  } else {
    avatarHtml = '<div class="person-avatar" style="background:' + color + '">' + initial + '</div>';
  }

  var creatorBadge = a.is_creator ? ' <span style="font-size:11px;color:#888">Â· host</span>' : '';
  return '<div class="person-row" style="cursor:pointer" ' + tap + '>' + avatarHtml + '<div class="person-name">' + a.nickname + creatorBadge + '</div>' + rightHtml + '</div>';
}

function openSheet() {
  deactivatePin();
  if (venuePinRef && venuePinRef.div) {
    venuePinRef.div.classList.add('active');
    activePinEl = venuePinRef.div;
  }
  var photoEl = document.getElementById('sheet-photo');
  if (VENUE_PHOTO_URL) {
    photoEl.innerHTML = '<img src="' + VENUE_PHOTO_URL + '" onerror="this.parentNode.innerHTML=\'<span class=initial>' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>\'">';
  } else {
    photoEl.innerHTML = '<span class="initial">' + (VENUE_NAME_STR[0] || '?').toUpperCase() + '</span>';
  }
  document.getElementById('sheet-venue-name').textContent = VENUE_NAME_STR;
  document.getElementById('sheet-venue-address').textContent = VENUE_ADDRESS_STR;

  var msgEl = document.getElementById('sheet-message');
  if (MESSAGE_STR) {
    msgEl.textContent = '"' + MESSAGE_STR + '"';
    msgEl.style.display = 'block';
  } else {
    msgEl.style.display = 'none';
  }

  document.getElementById('sheet-creator').textContent = 'by ' + CREATOR_NAME_STR;

  var listEl = document.getElementById('sheet-people-list');
  var colors = { app: '#9b59b6', guest: '#2ecc71', self: '#4a9eff' };

  // Show self row immediately
  var selfHtml = '';
  if (myName) {
    var selfPos = pinPositions['self'];
    var selfDist = selfPos ? '<div class="person-dist">' + formatDist(haversineDist(selfPos.lat, selfPos.lng, VENUE_LAT, VENUE_LNG)) + '</div>' : '';
    selfHtml = '<div class="person-row"><div class="person-avatar" style="background:' + colors.self + '">Y</div><div class="person-name">You (' + myName + ')</div>' + selfDist + '</div>';
  }
  listEl.innerHTML = selfHtml + '<div style="color:#666;font-size:13px;padding:8px 0">Loading...</div>';

  document.getElementById('sheet-backdrop').style.display = 'block';
  document.getElementById('bottom-sheet').classList.add('open');

  // Fetch full attendee list from server
  fetch('/bounce/share/' + SHARE_TOKEN + '/attendees')
    .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
    .then(function(data) {
      var html = selfHtml;
      (data.attendees || []).forEach(function(a) {
        // Skip self (current guest user)
        if (a.type === 'guest' && a.guest_id === myGuestId) return;
        html += buildAttendeeRow(a, colors);
      });
      if (!html) {
        html = '<div style="color:#666;font-size:13px;padding:8px 0">No attendees yet</div>';
      }
      listEl.innerHTML = html;
    })
    .catch(function() {
      listEl.innerHTML = selfHtml + '<div style="color:#666;font-size:13px;padding:8px 0">Failed to load attendees</div>';
    });
}

function closeSheet() {
  deactivatePin();
  document.getElementById('bottom-sheet').classList.remove('open');
  document.getElementById('sheet-backdrop').style.display = 'none';
}
</script>
