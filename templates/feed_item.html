<style>
.feed-item{display:flex;gap:8px;align-items:flex-start;padding:5px 0;animation:feedIn .3s ease}
@keyframes feedIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.feed-avatar{width:38px;height:38px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;font-weight:700;color:#fff;font-family:system-ui,-apple-system,sans-serif;overflow:hidden}
.feed-avatar.ai{background:rgba(74,158,255,.2);color:#4a9eff}
.feed-avatar.self{background:#4a9eff;color:#fff}
.feed-body{flex:1;min-width:0}
.feed-name{font-size:13px;font-weight:600;color:#4a9eff;margin-bottom:1px;font-family:system-ui,-apple-system,sans-serif}
.feed-name.ai{color:#7bb8ff}
.feed-name.self{color:#fff}
.feed-text{font-size:15px;line-height:1.35;color:#ccc;word-wrap:break-word;font-family:system-ui,-apple-system,sans-serif}
.feed-text.ai{color:#a8cce8;font-style:italic}
.feed-text.self{color:#fff}
.feed-system{font-size:13px;color:#555;text-align:center;padding:3px 0;font-family:system-ui,-apple-system,sans-serif}
.feed-time{font-size:12px;color:#444;margin-top:1px;font-family:system-ui,-apple-system,sans-serif}
</style>

<script>
function formatFeedTime(ts) {
  if (!ts) return '';
  var d = new Date(ts * 1000);
  var h = d.getHours();
  var m = d.getMinutes();
  return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
}

function renderChatMsg(sender, text, isAi, isSelf, timestamp, pic) {
  var container = document.getElementById('feed-messages');
  var item = document.createElement('div');
  item.className = 'feed-item';

  var avatar = document.createElement('div');
  var initial = (sender && sender[0]) ? sender[0].toUpperCase() : '?';

  if (isAi) {
    avatar.className = 'feed-avatar ai';
    avatar.textContent = 'AI';
  } else if (isSelf) {
    avatar.className = 'feed-avatar self';
    if (pic) {
      var img = document.createElement('img');
      img.src = pic.startsWith('data:') ? pic : '/bounce/img-proxy?url=' + encodeURIComponent(pic);
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%';
      img.onerror = function() { this.parentNode.textContent = initial; };
      avatar.textContent = '';
      avatar.appendChild(img);
    } else {
      avatar.textContent = initial;
    }
  } else {
    avatar.className = 'feed-avatar';
    if (pic) {
      var img = document.createElement('img');
      img.src = pic.startsWith('data:') ? pic : '/bounce/img-proxy?url=' + encodeURIComponent(pic);
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%';
      img.onerror = function() { this.parentNode.textContent = initial; };
      avatar.textContent = '';
      avatar.appendChild(img);
    } else {
      avatar.textContent = initial;
    }
  }

  var body = document.createElement('div');
  body.className = 'feed-body';

  var nameEl = document.createElement('div');
  nameEl.className = 'feed-name' + (isAi ? ' ai' : isSelf ? ' self' : '');
  nameEl.textContent = isAi ? 'Bounce AI' : (isSelf ? 'You' : sender);

  var textEl = document.createElement('div');
  textEl.className = 'feed-text' + (isAi ? ' ai' : isSelf ? ' self' : '');
  textEl.textContent = text;

  body.appendChild(nameEl);
  body.appendChild(textEl);

  if (timestamp) {
    var timeEl = document.createElement('div');
    timeEl.className = 'feed-time';
    timeEl.textContent = formatFeedTime(timestamp);
    body.appendChild(timeEl);
  }

  item.appendChild(avatar);
  item.appendChild(body);
  container.appendChild(item);
  scrollFeed();
}

function renderSystemMsg(text) {
  var container = document.getElementById('feed-messages');
  var div = document.createElement('div');
  div.className = 'feed-system';
  div.textContent = text;
  container.appendChild(div);
  scrollFeed();
}
</script>
